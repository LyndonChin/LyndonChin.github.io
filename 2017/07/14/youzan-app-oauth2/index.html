<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>有赞自有APP的OAuth2授权模型分析 | 梁飞</title>
  <meta name="author" content="liangfei">
  
  <meta name="description" content="梁飞的个人博客">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="有赞自有APP的OAuth2授权模型分析"/>
  <meta property="og:site_name" content="梁飞"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="梁飞" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  

</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">梁飞</a></h1>
  <h2><a href="/"></a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archive</a></li>
    
      <li><a href="/about">About</a></li>
    

    
      <li><a href="https://zhuanlan.zhihu.com/youzanmobile" target="_blank">知乎</a></li>
    
      <li><a href="https://github.com/lyndonchin" target="_blank">Github</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2017-07-13T16:00:00.000Z"><a href="/2017/07/14/youzan-app-oauth2/">2017-07-14</a></time>
      
      
  
    <h1 class="title">有赞自有APP的OAuth2授权模型分析</h1>
  

    </header>
    <div class="entry">
      
        <p>分析来源： <a href="https://tools.ietf.org/html/rfc6749" target="_blank" rel="external">The OAuth 2.0 Authorization Framework</a>。</p>
<a id="more"></a>
<p>有赞自有 APP（微商城、微小店、买家版）的 OAuth2 类型是 <strong>Resource Owner Password Credentials</strong>。</p>
<blockquote>
<p>The resource owner password credentials (i.e., username and password) can be used directly as an authorization grant to obtain an access token. The credentials should only be used when there is a high degree of trust between the resource owner and the client (e.g., the client is part of the device operating system or a highly privileged application), and when other authorization grant types are not available (such as an authorization code).</p>
<p>Even though this grant type requires direct client access to the resource owner credentials, the resource owner credentials are used for a single request and are exchanged for an access token. This grant type can eliminate the need for the client to store the resource owner credentials for future use, by exchanging the credentials with a long-lived access token or refresh token.</p>
</blockquote>
<p>其验证流程如下所示：</p>
<pre><code>+----------+
| Resource |
|  Owner   |
|          |
+----------+
    v
    |    Resource Owner
    (A) Password Credentials
    |
    v
+---------+                                  +---------------+
|         |&gt;--(B)---- Resource Owner -------&gt;|               |
|         |         Password Credentials     | Authorization |
| Client  |                                  |     Server    |
|         |&lt;--(C)---- Access Token ---------&lt;|               |
|         |    (w/ Optional Refresh Token)   |               |
+---------+                                  +---------------+

    Figure 5: Resource Owner Password Credentials Flow
</code></pre><p>可以通过一个具体的请求来分析一下登录流程：</p>
<p><strong>第一步：</strong> 用户（resource owner）通过 APP（client）向 SSO接入服务（<a href="https://uic.youzan.com/sso/yzApp/login）发起登录请求来获取" target="_blank" rel="external">https://uic.youzan.com/sso/yzApp/login）发起登录请求来获取</a> access token。</p>
<p>该请求必须是 POST 请求（Content-Type: application/x-www-form-urlencoded），请求参数如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">grant_type</div><div class="line">      REQUIRED.  Value MUST be set to &quot;password&quot;.</div><div class="line"></div><div class="line">username</div><div class="line">      REQUIRED.  The resource owner username.</div><div class="line"></div><div class="line">password</div><div class="line">      REQUIRED.  The resource owner password.</div><div class="line"></div><div class="line">scope</div><div class="line">      OPTIONAL.  The scope of the access request.</div></pre></td></tr></table></figure>
<p>除此之外还要带上客户端身份（client credentials）</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">client_id</div><div class="line">      REQUIRED.</div><div class="line"></div><div class="line">client_secret</div><div class="line">      REQUIRED.</div></pre></td></tr></table></figure>
<p><strong>第二步：</strong> SSO 接入服务拿到请求之后，先通过 username &amp; password 去 Account服务验证用户身份，然后携带 Account 服务返回的 user_id 以及 client_id &amp; client_secret 去 carmen-oauth 验证 client 身份，</p>
<img src="/2017/07/14/youzan-app-oauth2/auth-server.jpeg" alt="auth-server.jpeg" title="">
<blockquote>
<p>The authorization server MUST:</p>
<ul>
<li>require client authentication for confidential clients or for any client that was issued client credentials (or with other authentication requirements),</li>
<li>authenticate the client if client authentication is included, and</li>
<li>validate the resource owner password credentials using its existing password validation algorithm.</li>
</ul>
</blockquote>
<p><strong>第三步：</strong> 如果 client 和 resource owner 的身份验证成功，authorization server（SSO接入服务 &amp; carmen-oauth）就会签发 access_token 以及可选的 refresh_token。</p>
<p>Response 参数如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">The authorization server issues an access token and optional refresh token, </div><div class="line">and constructs the response by adding the following parameters </div><div class="line">to the entity-body of the HTTP response with a 200 (OK) status code:</div><div class="line"></div><div class="line">   access_token</div><div class="line">         REQUIRED.  The access token issued by the authorization server.</div><div class="line"></div><div class="line">   token_type</div><div class="line">         REQUIRED.  The type of the token issued as described in</div><div class="line">         Section 7.1.  Value is case insensitive.</div><div class="line"></div><div class="line">   expires_in</div><div class="line">         RECOMMENDED.  The lifetime in seconds of the access token.  For</div><div class="line">         example, the value &quot;3600&quot; denotes that the access token will</div><div class="line">         expire in one hour from the time the response was generated.</div><div class="line">         If omitted, the authorization server SHOULD provide the</div><div class="line">         expiration time via other means or document the default value.</div><div class="line">   </div><div class="line">   refresh_token</div><div class="line">         OPTIONAL.  The refresh token, which can be used to obtain new</div><div class="line">         access tokens using the same authorization grant as described</div><div class="line">         in Section 6.</div><div class="line"></div><div class="line">   scope</div><div class="line">         OPTIONAL, if identical to the scope requested by the client;</div><div class="line">         otherwise, REQUIRED.  The scope of the access token as</div><div class="line">         described by Section 3.3.</div></pre></td></tr></table></figure>
<h2 id="AppSDK-的-OAuth2-类型分析"><a href="#AppSDK-的-OAuth2-类型分析" class="headerlink" title="AppSDK 的 OAuth2 类型分析"></a>AppSDK 的 OAuth2 类型分析</h2><p>mo</p>

      
    </div>
    <footer>
      
        
        
  
  <div class="tags">
    <a href="/tags/OAuth2/">OAuth2</a>
  </div>

        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


<section id="comment">
  <h1 class="title">留言</h1>
  <div id="uyan_frame"></div>
  <script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=2128686"></script>
</section>


</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="搜索">
    <input type="hidden" name="q" value="site:liangfei.me">
  </form>
</div>

  

  
<div class="widget tagcloud">
  <h3 class="title">标签云</h3>
  <div class="entry">
    <a href="/tags/Android/" style="font-size: 20px;">Android</a> <a href="/tags/CSS/" style="font-size: 13.33px;">CSS</a> <a href="/tags/Car/" style="font-size: 10px;">Car</a> <a href="/tags/Dart/" style="font-size: 11.67px;">Dart</a> <a href="/tags/FP/" style="font-size: 10px;">FP</a> <a href="/tags/Git/" style="font-size: 11.67px;">Git</a> <a href="/tags/Google/" style="font-size: 10px;">Google</a> <a href="/tags/Gradle/" style="font-size: 10px;">Gradle</a> <a href="/tags/HTTP2/" style="font-size: 10px;">HTTP2</a> <a href="/tags/Hexo/" style="font-size: 10px;">Hexo</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/Mobile/" style="font-size: 10px;">Mobile</a> <a href="/tags/Mockito/" style="font-size: 15px;">Mockito</a> <a href="/tags/OAuth2/" style="font-size: 10px;">OAuth2</a> <a href="/tags/Retrofit/" style="font-size: 11.67px;">Retrofit</a> <a href="/tags/RxJava/" style="font-size: 10px;">RxJava</a> <a href="/tags/Security/" style="font-size: 10px;">Security</a> <a href="/tags/Summary/" style="font-size: 18.33px;">Summary</a> <a href="/tags/UnitTest/" style="font-size: 16.67px;">UnitTest</a> <a href="/tags/Web/" style="font-size: 11.67px;">Web</a> <a href="/tags/iOS/" style="font-size: 10px;">iOS</a> <a href="/tags/产品设计/" style="font-size: 10px;">产品设计</a> <a href="/tags/小程序/" style="font-size: 10px;">小程序</a>
  </div>
</div>


  
<div class="widget tag">
  <h3 class="title">最新文章</h3>
  <ul class="entry">
    
      <li>
        <a href="/2017/08/24/css-position/">精通CSS之position</a>
      </li>
    
      <li>
        <a href="/2017/08/22/meeting-css/">Beautiful CSS</a>
      </li>
    
      <li>
        <a href="/2017/08/21/meeting-weapp/">小程序开发总结</a>
      </li>
    
      <li>
        <a href="/2017/08/21/note-on-css-mastery/">CSS Mastery笔记</a>
      </li>
    
      <li>
        <a href="/2017/07/26/mockito-details-5-annotation/">Mockito 详解（五）MockitoAnnotation</a>
      </li>
    
  </ul>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2017 liangfei
  
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>