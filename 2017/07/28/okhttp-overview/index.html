<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>OkHttp略读 | 梁飞</title>
  <meta name="author" content="liangfei">
  
  <meta name="description" content="梁飞的个人博客">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="OkHttp略读"/>
  <meta property="og:site_name" content="梁飞"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="梁飞" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  

</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">梁飞</a></h1>
  <h2><a href="/">行有不得反求诸己</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
      <li><a href="/about">About</a></li>
    
    <li><a href="https://github.com/lyndonchin">Github</a></li>
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2017-07-28T00:54:41.000Z"><a href="/2017/07/28/okhttp-overview/">2017-07-28</a></time>
      
      
  
    <h1 class="title">OkHttp略读</h1>
  

    </header>
    <div class="entry">
      
        <pre><code>                   +--------------------------------------+
                   | GET /specials/saw-blade.gif HTTP/1.0 |
     |&gt;==REQUEST==&gt;|                                      |&gt;========&gt;|
     |             | Host: www.joes-hardware.com          |          |
     |             +--------------------------------------+          |
+--------+                                                       +--------+
| CLIENT |                                                       | SERVER |
+--------+                                                       +--------+ 
     |                  +-------------------------+                  |
     |                  | HTTP/1.0 200 OK         |                  |
     |&lt;==RESPONSE======&lt;| Content-type: image/gif |&lt;================&lt;|
                        | Content-length: 8572    |
                        +-------------------------+
</code></pre><a id="more"></a>
<h2 id="Request"><a href="#Request" class="headerlink" title="Request"></a>Request</h2><p>上图是一个最简单的HTTP请求，OkHttp用如下字段来表示一个REQUEST：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Request</span> </span>&#123;</div><div class="line">  <span class="keyword">final</span> HttpUrl url;</div><div class="line">  <span class="keyword">final</span> String method;</div><div class="line">  <span class="keyword">final</span> Headers headers;</div><div class="line">  <span class="keyword">final</span> <span class="meta">@Nullable</span> RequestBody body;</div><div class="line"></div><div class="line">  <span class="keyword">final</span> Object tag;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<ul>
<li><code>final</code>标记的字段是<code>immutable</code>，需要在构造时赋值，并且赋值之后指针不能再改变</li>
<li><code>body</code>用<code>@Nullable</code>标记，说明<code>RequestBody</code>可以为空</li>
<li><code>tag</code>用于标记本次<code>Request</code>，可以通过tag取消本次请求</li>
</ul>
</blockquote>
<h2 id="Response"><a href="#Response" class="headerlink" title="Response"></a>Response</h2><p><code>Response</code>字段如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> Request request;</div><div class="line"><span class="keyword">final</span> Protocol protocol;</div><div class="line"><span class="keyword">final</span> <span class="keyword">int</span> code;</div><div class="line"><span class="keyword">final</span> String message;</div><div class="line"><span class="keyword">final</span> <span class="meta">@Nullable</span> Handshake handshake;</div><div class="line"><span class="keyword">final</span> Headers headers;</div><div class="line"><span class="keyword">final</span> <span class="meta">@Nullable</span> ResponseBody body;</div><div class="line"><span class="keyword">final</span> <span class="meta">@Nullable</span> Response networkResponse;</div><div class="line"><span class="keyword">final</span> <span class="meta">@Nullable</span> Response cacheResponse;</div><div class="line"><span class="keyword">final</span> <span class="meta">@Nullable</span> Response priorResponse;</div><div class="line"></div><div class="line"><span class="keyword">final</span> <span class="keyword">long</span> sentRequestAtMillis;</div><div class="line"><span class="keyword">final</span> <span class="keyword">long</span> receivedResponseAtMillis;</div></pre></td></tr></table></figure>
<h2 id="Connection"><a href="#Connection" class="headerlink" title="Connection"></a>Connection</h2><p>The sockets and streams of an HTTP, HTTPS, or HTTPS+HTTP/2 connection.<br>May be used for multiple HTTP request/response exchanges.<br>Connections may be direct to the origin server or via a proxy.</p>
<h3 id="Modern-TLS"><a href="#Modern-TLS" class="headerlink" title="Modern TLS"></a>Modern TLS</h3><p>There are tradeoffs when selecting which options to include when negotiating a secure connection to a remote host. Newer TLS options are quite useful:</p>
<ul>
<li>Server Name Indication (SNI) enables one IP address to negotiate secure connections for multiple domain names.</li>
<li>Application Layer Protocol Negotiation (ALPN) enables the HTTPS port (443) to be used to negotiate HTTP/2.</li>
</ul>
<p>Unfortunately, older HTTPS servers refuse to connect when such options are presented. Rather than avoiding these options entirely, this class allows a connection to be attempted with modern options and then retried without them should the attempt fail.</p>
<h3 id="Connection-Reuse"><a href="#Connection-Reuse" class="headerlink" title="Connection Reuse"></a>Connection Reuse</h3><p>Each connection can carry a varying number streams, depending on the underlying protocol being used. HTTP/1.x connections can carry either zero or one streams. HTTP/2 connections can carry any number of streams, dynamically configured with SETTINGS_MAX_CONCURRENT_STREAMS. A connection currently carrying zero streams is an idle stream. We keep it alive because reusing an existing connection is typically faster than establishing a new one.</p>
<p>When a single logical call requires multiple streams due to redirects or authorization challenges, we prefer to use the same physical connection for all streams in the sequence. There are potential performance and behavior consequences to this preference. To support this feature, this class separates allocations from streams. An allocation is created by a call, used for one or more streams, and then released. An allocated connection won’t be stolen by other calls while a redirect or<br>authorization challenge is being handled.</p>
<p>When the maximum concurrent streams limit is reduced, some allocations will be rescinded. Attempting to create new streams on these allocations will fail.</p>
<p>Note that an allocation may be released before its stream is completed. This is intended to make bookkeeping easier for the caller: releasing the allocation as soon as the terminal stream has been found. But only complete the stream once its data stream has been exhausted.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Connection</span> </span>&#123;</div><div class="line">  <span class="comment">/** Returns the route used by this connection. */</span></div><div class="line">  <span class="function">Route <span class="title">route</span><span class="params">()</span></span>;</div><div class="line">  <span class="function">Socket <span class="title">socket</span><span class="params">()</span></span>;</div><div class="line">  <span class="meta">@Nullable</span> <span class="function">Handshake <span class="title">handshake</span><span class="params">()</span></span>;</div><div class="line">  <span class="function">Protocol <span class="title">protocol</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="StreamAllocation"><a href="#StreamAllocation" class="headerlink" title="StreamAllocation"></a>StreamAllocation</h2><p>This class coordinates the relationship between three entities:</p>
<ul>
<li><strong>Connections</strong>: physical socket connections to remote servers. These are potentially slow to establish so it is necessary to be able to cancel a connection currently being connected.</li>
<li><strong>Streams</strong>: logical HTTP request/response pairs that are layered on connections. Each connection has its own allocation limit, which defines how many concurrent streams that connection can carry. HTTP/1.x connections can carry 1 stream at a time, SPDY and HTTP/2 typically carry multiple.</li>
<li><strong>Calls</strong>: a logical sequence of streams, typically an initial request and its follow up requests. We prefer to keep all streams of a single call on the same connection for better behavior and locality.</li>
</ul>
<p>Instances of this class act on behalf of the call, using one or more streams over one or more connections. This class has APIs to release each of the above resources:</p>
<ul>
<li><code>noNewStreams()</code> prevents the connection from being used for new streams in the future. Use this after a Connection: close header, or when the connection may be inconsistent.</li>
<li><code>streamFinished()</code> releases the active stream from this allocation. Note that only one stream may be active at a given time, so it is necessary to call streamFinished() before creating a subsequent stream with newStream().</li>
<li><code>release()</code> removes the call’s hold on the connection. Note that this won’t immediately free the connection if there is a stream still lingering. That happens when a call is complete but its response body has yet to be fully consumed.</li>
</ul>
<p>This class supports asynchronous canceling. This is intended to have the smallest blast radius possible. If an HTTP/2 stream is active, canceling will cancel that stream but not the other streams sharing its connection. But if the TLS handshake is still in progress then canceling may break the entire connection.</p>

      
    </div>
    <footer>
      
        
        
  
  <div class="tags">
    <a href="/tags/OkHttp/">OkHttp</a>, <a href="/tags/网络/">网络</a>
  </div>

        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


<section id="comment">
  <h1 class="title">留言</h1>
  <div id="uyan_frame"></div>
  <script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=2128686"></script>
</section>


</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="搜索">
    <input type="hidden" name="q" value="site:liangfei.me">
  </form>
</div>

  

  
<div class="widget tagcloud">
  <h3 class="title">标签云</h3>
  <div class="entry">
    <a href="/tags/Android/" style="font-size: 20px;">Android</a> <a href="/tags/Git/" style="font-size: 12px;">Git</a> <a href="/tags/Gradle/" style="font-size: 10px;">Gradle</a> <a href="/tags/Hybrid/" style="font-size: 10px;">Hybrid</a> <a href="/tags/Java/" style="font-size: 16px;">Java</a> <a href="/tags/Mockito/" style="font-size: 16px;">Mockito</a> <a href="/tags/OkHttp/" style="font-size: 10px;">OkHttp</a> <a href="/tags/Retrofit/" style="font-size: 12px;">Retrofit</a> <a href="/tags/RxJava/" style="font-size: 10px;">RxJava</a> <a href="/tags/Web/" style="font-size: 12px;">Web</a> <a href="/tags/dart/" style="font-size: 10px;">dart</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/iOS/" style="font-size: 10px;">iOS</a> <a href="/tags/个人总结/" style="font-size: 18px;">个人总结</a> <a href="/tags/产品设计/" style="font-size: 10px;">产品设计</a> <a href="/tags/前端/" style="font-size: 12px;">前端</a> <a href="/tags/单元测试/" style="font-size: 10px;">单元测试</a> <a href="/tags/汽车/" style="font-size: 10px;">汽车</a> <a href="/tags/测试/" style="font-size: 14px;">测试</a> <a href="/tags/移动开发/" style="font-size: 10px;">移动开发</a> <a href="/tags/网络/" style="font-size: 10px;">网络</a>
  </div>
</div>


  
<div class="widget tag">
  <h3 class="title">最新文章</h3>
  <ul class="entry">
    
      <li>
        <a href="/2017/08/22/beautiful-css/">Beautiful CSS</a>
      </li>
    
      <li>
        <a href="/2017/08/21/summary-of-weapp/">小程序开发总结</a>
      </li>
    
      <li>
        <a href="/2017/07/28/okhttp-overview/">OkHttp略读</a>
      </li>
    
      <li>
        <a href="/2017/07/26/mockito-details-5-annotation/">Mockito 详解（五）MockitoAnnotation</a>
      </li>
    
      <li>
        <a href="/2017/07/25/mockito-details-4-session/">Mockito 详解（四）MockitoSession</a>
      </li>
    
  </ul>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2017 liangfei
  
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>


<script type="text/javascript">
var disqus_shortname = 'liangfeizc';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>