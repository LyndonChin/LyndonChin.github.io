<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>梁飞</title>
  <meta name="author" content="liangfei">
  
  <meta name="description" content="梁飞的个人博客">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="梁飞"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="梁飞" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  

</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">梁飞</a></h1>
  <h2><a href="/">一切唯心造（清も濁も全ては心が作り出すもの）</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
      <li><a href="/about">About</a></li>
    
    <li><a href="https://github.com/lyndonchin">Github</a></li>
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper">
  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2016-07-20T13:33:33.000Z"><a href="/2016/07/20/the-weird-NoClassDefFoundError/">2016-07-20</a></time>
      
      
  
    <h1 class="title"><a href="/2016/07/20/the-weird-NoClassDefFoundError/">诡异的问题 NoClassDefFoundError</a></h1>
  

    </header>
    <div class="entry">
      
        <p>今天又遇到一个比较难搞的问题，记一下流水账。</p>
<p>APP 中引用了一个二方包，编译成功，结果运行时报错 - <code>NoClassDefFoundError</code>。</p>
<h2 id="try-1-multiDexKeepProguard"><a href="#try-1-multiDexKeepProguard" class="headerlink" title="try #1 - multiDexKeepProguard"></a>try #1 - multiDexKeepProguard</h2><p>首先确认是不是由于类没有被放到 main dex 中导致了这个问题。打开文件 <code>build/intermediates/multi-dex/debug/maindexlist.txt</code>，查找类名，发现文件中包含了我们要找的类。</p>
<p>不放心，说不定是 Multidex 的bug，手动把这个“丢失”的类放进 main dex。</p>
<p><em>build.gralde</em><br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">android &#123;</div><div class="line">  defaultConfig &#123;</div><div class="line">    multiDexEnabled = <span class="literal">true</span></div><div class="line">    multiDexKeepProguard file(<span class="string">'multidex.pro'</span>)</div><div class="line">  &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><em>multidex.pro</em><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">-keep public the-full-name-of-the-missing-class &#123; *; &#125;</div></pre></td></tr></table></figure></p>
<p>编译运行，问题依然，并没有什么卵用。</p>
<p>既然不是 main dex 问题，那我们先来确认一下问题是否由 MultiDex 引起。</p>
<h2 id="try-2-关掉-Multidex"><a href="#try-2-关掉-Multidex" class="headerlink" title="try #2 - 关掉 Multidex"></a>try #2 - 关掉 Multidex</h2><p>关掉 multidex 然后打一个 release 包。</p>
<blockquote>
<p>由于方法数受限，关掉 Multidex 之后打不出 Debug 包，但是混淆过后方法数减少很多，可以顺利打出 Release 包。</p>
</blockquote>
<p><em>build.gradle</em><br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">defaultConfig &#123;</div><div class="line">  multiDexEnabled <span class="literal">true</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>编译运行，依然出错，可以确定不是 Multidex 的锅。</p>
<h2 id="try-3-传递依赖"><a href="#try-3-传递依赖" class="headerlink" title="try #3 - 传递依赖"></a>try #3 - 传递依赖</h2><p>把依赖由只依赖 aar 改为传递依赖。</p>
<p><del><code>compile &#39;me.liangfei.android:weird-1.0.0@aar&#39;</code></del><br><code>compile &#39;me.liangfei.android:weird-1.0.0&#39;</code></p>
<p>结果却发现 <code>weird.aar</code> 引用了一个<strong>服务端已经删除但是有本地缓存</strong>的包，也就是说 <code>weird.aar</code> 引用了一个并不存在的包，所以改为传递依赖之后，gradle 无法获取这个并不存在的包。</p>
<p>由此推断出，<code>weird.aar</code> 肯定不是一个“正确”的包，估计上面的问题也是由此引发（待确认）。</p>
<hr>
<h2 id="ClassNotFoundException-vs-NoClassDefFoundError"><a href="#ClassNotFoundException-vs-NoClassDefFoundError" class="headerlink" title="ClassNotFoundException vs NoClassDefFoundError"></a>ClassNotFoundException vs NoClassDefFoundError</h2><ul>
<li><code>ClassNotFoundException</code> 一般是 <code>ClassLoader</code> 无法找到类导致的，例如 <code>Class.forName(&quot;your-class&quot;)</code>。</li>
<li><code>NoClassDefFoundError</code> 一般是属于 <strong>Link Error</strong>，主要是由于打包之后缺失文件导致的，例如 <code>new</code> 一个对象。</li>
</ul>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2016-07-17T15:21:41.000Z"><a href="/2016/07/17/一切唯心造/">2016-07-17</a></time>
      
      
  
    <h1 class="title"><a href="/2016/07/17/一切唯心造/">一切唯心造</a></h1>
  

    </header>
    <div class="entry">
      
        <blockquote>
<p>清も濁もすべては心がつくりだすもの</p>
</blockquote>
      
    </div>
    <footer>
      
        
          <div class="alignleft">
            <a href="/2016/07/17/一切唯心造/#more" class="more-link">更多...</a>
          </div>
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2016-07-09T16:00:00.000Z"><a href="/2016/07/10/diagram-retrofit-service-method/">2016-07-10</a></time>
      
      
  
    <h1 class="title"><a href="/2016/07/10/diagram-retrofit-service-method/">图解 Retrofit 之 ServiceMethod</a></h1>
  

    </header>
    <div class="entry">
      
        <p>通过 <a href="http://www.liangfei.me/2016/07/06/my-practice-of-retrofit-and-rxandroid/" target="_blank" rel="external">Retrofit + RxAndroid 实践总结</a>，我们已经了解到了 Retrofit 的基本用法，为了知其所以然，我们以图解加源码的方式从 Service Method 入手，逐步解析 Retrofit。</p>
<p>首先以官方网站的示例代码为例，看一下一个 Service Method 的组成部分。</p>
<img src="/2016/07/10/diagram-retrofit-service-method/service_method.png" alt="service method" title="service method">
<p><code>ServiceMethod</code> 使用了 Builder 模式，先来看 <code>ServiceMethod.Builder</code> 的构造方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">Builder</span><span class="params">(Retrofit retrofit, Method method)</span> </span>&#123;</div><div class="line">  <span class="keyword">this</span>.retrofit = retrofit;</div><div class="line">  <span class="keyword">this</span>.method = method;</div><div class="line">  <span class="keyword">this</span>.methodAnnotations = method.getAnnotations();</div><div class="line">  <span class="keyword">this</span>.parameterTypes = method.getGenericParameterTypes();</div><div class="line">  <span class="keyword">this</span>.parameterAnnotationsArray = method.getParameterAnnotations();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>构造方法接受两个参数 - <code>retrofit</code> 和 <code>method</code>，然后通过调用 <code>Method</code> 类的方法获取以下数据：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> Annotation[] methodAnnotations;</div><div class="line"><span class="keyword">final</span> Annotation[][] parameterAnnotationsArray;</div><div class="line"><span class="keyword">final</span> Type[] parameterTypes;</div></pre></td></tr></table></figure>
<p><code>methodAnnotations</code> 就对应着上例中的  <code>@GET(&quot;users/{user}/repos&quot;</code>，由 <code>parseMethodAnnotation</code> 负责解析。</p>
<p>method parameter 也有对应的 annotation type，由对应的 <code>ParameterHandler</code> 进行处理，例如上例中的 <code>@Path</code> 就对应着 <code>class Path&lt;T&gt; extends ParameterHandler&lt;T&gt;</code>。</p>
<p>一个 parameter 可以有多个 annotation，所以  <code>parameterAnnotationsArray</code> 是一个二维数组 - <code>Annotation[][]</code>。</p>
<p><code>ServiceMethod.Builder</code> 最终会 <code>build</code> 出一个 <code>ServiceMethod</code> 实例，我们先来看 method annotations 的解析过程。</p>
<h2 id="method-annotations"><a href="#method-annotations" class="headerlink" title="method annotations"></a>method annotations</h2><p><em>ServiceMethod.Builder#build</em><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (Annotation annotation : methodAnnotations) &#123;</div><div class="line">  parseMethodAnnotation(annotation);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>如下图所示，<code>parseMethodAnnotation</code> 方法根据 method annotation 的类型（蓝色框内）生成一个 request 所需要的数据（褐色框内）。</p>
<img src="/2016/07/10/diagram-retrofit-service-method/parse_method_annotation.png" alt="parse method annotation" title="parse method annotation">
<p>其中 <code>httpMethod</code> 不能为空，如果 <code>hasBody == false</code>，那么 <code>isMultipart</code> 和 <code>isFormEncoded</code> 也必须为 <code>false</code>，而且两者互斥不能同时为 <code>true</code>，否则会抛出异常。</p>
<p>解析完 method annotations 之后，再来解析  parameters（代码示例中的 <code>@Path(&quot;user&quot;) String user</code>）。</p>
<h2 id="parameters"><a href="#parameters" class="headerlink" title="parameters"></a>parameters</h2><img src="/2016/07/10/diagram-retrofit-service-method/parse_parameter.png" alt="parse parameters" title="parse parameters">
<p>每一个 parameter annotation 类型都有对应的 <code>ParameterHandler</code>，method parameters 解析完成之后生成一个数组 - <code>ParameterHandler[] parameterHandlers</code>，这个数组在后面构建 request 的时候会用到。</p>
<p>解析过程中会验证 <code>@Path</code> value 的合法性，并确保 value 在 <code>relativeUrlParamNames</code>（<em>由 method annotations 生成</em>） 中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Upper and lower characters, digits, underscores, and hyphens, starting with a character.</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> String PARAM = <span class="string">"[a-zA-Z][a-zA-Z0-9_-]*"</span>;</div><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> Pattern PARAM_URL_REGEX = Pattern.compile(<span class="string">"\\&#123;("</span> + PARAM + <span class="string">")\\&#125;"</span>);</div><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> Pattern PARAM_NAME_REGEX = Pattern.compile(PARAM);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">validatePathName</span><span class="params">(<span class="keyword">int</span> p, String name)</span> </span>&#123;</div><div class="line">  <span class="keyword">if</span> (!PARAM_NAME_REGEX.matcher(name).matches()) &#123;</div><div class="line">    <span class="keyword">throw</span> parameterError(p, <span class="string">"@Path parameter name must match %s. Found: %s"</span>,</div><div class="line">        PARAM_URL_REGEX.pattern(), name);</div><div class="line">  &#125;</div><div class="line">  <span class="comment">// Verify URL replacement name is actually present in the URL path.</span></div><div class="line">  <span class="keyword">if</span> (!relativeUrlParamNames.contains(name)) &#123;</div><div class="line">    <span class="keyword">throw</span> parameterError(p, <span class="string">"URL \"%s\" does not contain \"&#123;%s&#125;\"."</span>, relativeUrl, name);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>parseParameterAnnotation</code>  方法在解析 <code>Url</code> 类型的 parameter annotation 时会判断 parameter 类型，由于 Retrofit 本身没有依赖 Android SDK，所以无法像 <code>HttpUrl.class</code> 那样获取 <code>Uri.class</code>，但是 Retrofit 的实现很巧妙，学到了：）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (type == HttpUrl.class</div><div class="line">    || type == String.class</div><div class="line">    || type == URI.class</div><div class="line">    || (type <span class="keyword">instanceof</span> Class &amp;&amp; <span class="string">"android.net.Uri"</span>.equals(((Class&lt;?&gt;) type).getName()))) &#123;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">new</span> ParameterHandler.RelativeUrl();</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">  <span class="keyword">throw</span> parameterError(p,</div><div class="line">      <span class="string">"@Url must be okhttp3.HttpUrl, String, java.net.URI, or android.net.Uri type."</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>method annotations 以及 parameters 都解析完成后，我们再回到 service method 的 callAdapter。</p>
<h2 id="CallAdapter"><a href="#CallAdapter" class="headerlink" title="CallAdapter"></a>CallAdapter</h2><p>想要了解 <code>CallAdapter</code> 的功能，我们需要先从 <code>Retrofit</code> 的 <code>create</code> 方法开始分析。</p>
<p><code>create</code> 方法使用<strong>动态代理</strong>把 service method 的调用转发给一个 <code>InvocationHandler</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ServiceMethod serviceMethod = loadServiceMethod(method);</div><div class="line">OkHttpCall okHttpCall = <span class="keyword">new</span> OkHttpCall&lt;&gt;(serviceMethod, args);</div><div class="line"><span class="keyword">return</span> serviceMethod.callAdapter.adapt(okHttpCall);</div></pre></td></tr></table></figure>
<p>由以上代码可以看出，<code>CallAdapter</code> 会把一个 <code>Call</code> 类型适配为用户定义的 service method 的 return type。</p>
<p>举个例子，如果我们配合 RxAndroid 使用 Retrofit，service method 的返回值类型会由 <code>Call</code> 类型变成 <code>Observable</code> 类型，这个转换其实就由 <code>RxJavaCallAdapterFactory</code> 来实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Retrofit retrofit = <span class="keyword">new</span> Retrofit.Builder()      </div><div class="line">    .addCallAdapterFactory(RxJavaCallAdapterFactory.create())</div><div class="line">    .baseUrl(BASE_URL) .build();</div></pre></td></tr></table></figure>
<p>由以上代码可以看出，<code>RxJavaCallAdapterFactory</code> 是通过 <code>Retrofit.Builder</code> 的<br><code>addCallAdapterFactory</code> 方法传递给 <code>Retrofit</code>，而 <code>create</code> 方法中 <code>adapt</code> 的执行者却是 <code>ServiceMethod</code>，也就是说 <code>ServiceMethod</code> 的 <code>CallAdapter</code> 是由 <code>Retrofit</code> 提供的，两者的交互关系如下图所示：</p>
<img src="/2016/07/10/diagram-retrofit-service-method/retrofit_and_service_method.png" alt="retrofit vs service method" title="retrofit vs service method">
<h2 id="未完待续"><a href="#未完待续" class="headerlink" title="未完待续"></a>未完待续</h2><p>敬请期待下一篇 - <strong>图解 Retrofit - Converter</strong></p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2016-07-05T16:00:00.000Z"><a href="/2016/07/06/my-practice-with-retrofit-and-rxjava/">2016-07-06</a></time>
      
      
  
    <h1 class="title"><a href="/2016/07/06/my-practice-with-retrofit-and-rxjava/">Retrofit + RxAndroid 实践总结</a></h1>
  

    </header>
    <div class="entry">
      
        <p>在接入 Retrofit + RxAndroid 之前，项目代码中主要存在如下问题：</p>
<ol>
<li>服务器 API 的定义方式不一致，有的集中定义，有的定义在业务代码中，没有分类不便于维护。</li>
<li>Request / Response / API 三者没有对应关系（Request 参数使用 Map 传递，Response 返回 JSON 数据）。</li>
<li>每次都需要传递 <code>access_token</code> 给需要验证登录的 API。</li>
<li>Response 中错误信息的数据结构不一致，错误处理不统一。</li>
</ol>
<p>引入 Retrofit + RxAndroid 后，以上问题都会迎刃而解。</p>
<h2 id="定义基类"><a href="#定义基类" class="headerlink" title="定义基类"></a>定义基类</h2><p>首先定义一个 <code>BaseResponse</code>，所有的 Response 都要继承自它。</p>
<h3 id="Response"><a href="#Response" class="headerlink" title="Response"></a>Response</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Keep</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseResponse</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CODE_SUCCESS = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> String msg;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> code;</div><div class="line">    <span class="meta">@SerializedName</span>(<span class="string">"error_response"</span>)</div><div class="line">    <span class="keyword">public</span> ErrorResponse errorResponse;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ErrorResponse</span> </span>&#123;</div><div class="line">        <span class="keyword">public</span> String msg;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">int</span> code;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>BaseResponse</code> 的主要作用是统一了错误信息的格式，同时为后面统一错误处理打好基础。</p>
<h3 id="ErrorResponseException"><a href="#ErrorResponseException" class="headerlink" title="ErrorResponseException"></a>ErrorResponseException</h3><p>为了统一<strong>请求错误</strong>和<strong>返回错误</strong>，我们定义了一个继承自 <code>IOException</code> 的子类 <code>ErrorResponseException</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ErrorResponseException</span> <span class="keyword">extends</span> <span class="title">IOException</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ErrorResponseException</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ErrorResponseException</span><span class="params">(String detailMessage)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(detailMessage);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="定义-Service-Method"><a href="#定义-Service-Method" class="headerlink" title="定义 Service Method"></a>定义 Service Method</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TradesService</span> </span>&#123;</div><div class="line">    <span class="meta">@GET</span>(<span class="string">"api.tradecategories/1.0.0/get"</span>)</div><div class="line">    Observable&lt;Response&lt;CategoryResponse&gt;&gt; tradeCategories();</div><div class="line"></div><div class="line">    <span class="meta">@FormUrlEncoded</span></div><div class="line">    <span class="meta">@GET</span>(<span class="string">"api.trade/1.0.0/get"</span>)</div><div class="line">    Observable&lt;Response&lt;TradeItemResponse&gt;&gt; tradeDetail(<span class="meta">@Field</span>(<span class="string">"tid"</span>) String tid);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其中 <code>CategoryResponse</code>、<code>TradeItemResponse</code> 全部继承自 <code>BaseResponse</code>。</p>
<p>泛型 <code>Response</code> 由 Retrofit 提供，定义了三个成员变量：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> okhttp3.Response rawResponse;</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> T body;</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> ResponseBody errorBody;</div></pre></td></tr></table></figure>
<p>可以看出，<code>Response</code> 是对 <code>okhttp3.Response</code> 的封装，<code>body</code> 是一个 <code>BaseResponse</code> 实例。</p>
<p>因为 <code>Response</code> 只会根据 <code>code</code> 值判断请求是否成功，而不会判断 <code>body</code> 的内容是否出错，所以我们把 <code>Response</code> 中的错误信息称作<strong>请求错误</strong>，把 <code>body</code> 中的错误信息称作<strong>返回错误</strong>。</p>
<p>既然 <code>Response</code> 包含了 <code>BaseResponse</code>（即 <code>body</code>），那么我们就可以对两种错误（请求错误、返回错误）进行统一处理。</p>
<h2 id="统一错误处理"><a href="#统一错误处理" class="headerlink" title="统一错误处理"></a>统一错误处理</h2><p>Service Method 的返回值类型是 <code>Observable&lt;Response&lt;? extends BaseResponse&gt;</code>，实际上业务方想要的是 <code>Observable&lt;? extends BaseResponse&gt;</code>，那么我们就定义一个 <code>Transformer</code> 来转换这两个 <code>Observable</code>。</p>
<p><strong>转换过程其实就是一个错误处理的过程</strong>，因为我们要从 <code>Response</code> 中把 <code>BaseResponse</code> 剥离出来，如果 <code>Response</code> 或者 <code>BaseResponse</code> 中含有错误信息则意味着<strong>转换失败</strong>，直接抛出我们已经定义好的 <code>BaseErrorResponse</code>，回调  <code>Subscriber</code> 的 <code>onError</code> 方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ErrorCheckerTransformer</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">Response</span>&lt;<span class="title">R</span>&gt;, <span class="title">R</span> <span class="keyword">extends</span> <span class="title">BaseResponse</span>&gt;</span></div><div class="line">        <span class="keyword">implements</span> <span class="title">Observable</span>.<span class="title">Transformer</span>&lt;<span class="title">T</span>, <span class="title">R</span>&gt; &#123;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_ERROR_MESSAGE = <span class="string">"Oh, no"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Context mContext;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ErrorCheckerTransformer</span><span class="params">(<span class="keyword">final</span> Context context)</span> </span>&#123;</div><div class="line">        mContext = context;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Observable&lt;R&gt; <span class="title">call</span><span class="params">(Observable&lt;T&gt; observable)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> observable.map(<span class="keyword">new</span> Func1&lt;T, R&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> R <span class="title">call</span><span class="params">(T t)</span> </span>&#123;</div><div class="line">                String msg = <span class="keyword">null</span>;</div><div class="line">                <span class="keyword">if</span> (!t.isSuccessful() || t.body() == <span class="keyword">null</span>) &#123;</div><div class="line">                    msg = DEFAULT_ERROR_MESSAGE;</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (t.body().errorResponse != <span class="keyword">null</span>) &#123;</div><div class="line">                    msg = t.body().errorResponse.msg;</div><div class="line">                    <span class="keyword">if</span> (msg == <span class="keyword">null</span>) &#123;</div><div class="line">                        msg = DEFAULT_ERROR_MESSAGE;</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (t.body().code != BaseResponse.CODE_SUCCESS) &#123;</div><div class="line">                    msg = t.body().msg;</div><div class="line">                    <span class="keyword">if</span> (msg == <span class="keyword">null</span>) &#123;</div><div class="line">                        msg = DEFAULT_ERROR_MESSAGE;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (msg != <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> ErrorResponseException(msg);</div><div class="line">                    &#125; <span class="keyword">catch</span> (ErrorResponseException e) &#123;</div><div class="line">                        <span class="keyword">throw</span> Exceptions.propagate(e);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">return</span> t.body();</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当然，你也可以在这里判断是否需要唤起登录请求。</p>
<h2 id="创建-Service-Method"><a href="#创建-Service-Method" class="headerlink" title="创建 Service Method"></a>创建 Service Method</h2><p>不同的 Service Method 可能对应着不同的网关，因此我们需要定义一个工厂为不同的网关生产 Service Method。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceFactory</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String OLD_BASE_URL = <span class="string">"https://liangfeizc.com/gw/oauthentry/"</span>;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String NEW_BASE_URL = <span class="string">"https://liangfei.me/api/oauthentry/"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> OkHttpClient sClient = <span class="keyword">new</span> OkHttpClient.Builder()</div><div class="line">            .addInterceptor(<span class="keyword">new</span> Interceptor() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> Response <span class="title">intercept</span><span class="params">(Chain chain)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">                    Request request = chain.request();</div><div class="line">                    HttpUrl url = request.url().newBuilder()</div><div class="line">                            .addQueryParameter(<span class="string">"access_token"</span>, UserInfo.getAccessToken())</div><div class="line">                            .build();</div><div class="line">                    request = request.newBuilder().url(url).build();</div><div class="line">                    <span class="keyword">return</span> chain.proceed(request);</div><div class="line">                &#125;</div><div class="line">            &#125;)</div><div class="line">            .build();</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">createOldService</span><span class="params">(Class&lt;T&gt; serviceClazz)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> createOauthService(OLD_BASE_URL, serviceClazz);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">createNewService</span><span class="params">(Class&lt;T&gt; serviceClazz)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> createOauthService(NEW_BASE_URL, serviceClazz);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">createOauthService</span><span class="params">(String baseUrl, Class&lt;T&gt; serviceClazz)</span> </span>&#123;</div><div class="line">        Retrofit retrofit = <span class="keyword">new</span> Retrofit.Builder()</div><div class="line">                .client(sClient)</div><div class="line">                .baseUrl(baseUrl)</div><div class="line">                .addConverterFactory(GsonConverterFactory.create())</div><div class="line">                .addCallAdapterFactory(RxJavaCallAdapterFactory.create())</div><div class="line">                .build();</div><div class="line"></div><div class="line">        <span class="keyword">return</span> retrofit.create(serviceClazz);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>因为这两个网关都要求登录后才能访问，因此我们通过 <code>OkHttpClient#addInterceptor</code> 拦截 <code>Request</code> 之后加上了参数 <code>access_token</code>。</p>
<h2 id="线程模型"><a href="#线程模型" class="headerlink" title="线程模型"></a>线程模型</h2><p>大多数情况下，我们都会在 io 线程发起 request，在主线程处理 response，所以我们定义了一个默认的线程模型：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SchedulerTransformer</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Observable</span>.<span class="title">Transformer</span>&lt;<span class="title">T</span>, <span class="title">T</span>&gt; </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Observable&lt;T&gt; <span class="title">call</span><span class="params">(Observable&lt;T&gt; observable)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> observable</div><div class="line">                .subscribeOn(Schedulers.io())</div><div class="line">                .observeOn(AndroidSchedulers.mainThread());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">SchedulerTransformer&lt;T&gt; <span class="title">create</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SchedulerTransformer&lt;&gt;();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>为了方便使用，我们又定义了一个 <code>DefaultTransformer</code> 把 <code>SchedulerTransformer</code> 和 <code>ErrorCheckerTransformer</code> 结合起来。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultTransformer</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">Response</span>&lt;<span class="title">R</span>&gt;, <span class="title">R</span> <span class="keyword">extends</span> <span class="title">BaseResponse</span>&gt;</span></div><div class="line">        <span class="keyword">implements</span> <span class="title">Observable</span>.<span class="title">Transformer</span>&lt;<span class="title">T</span>, <span class="title">R</span>&gt; &#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Context mContext;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DefaultTransformer</span><span class="params">(<span class="keyword">final</span> Context context)</span> </span>&#123;</div><div class="line">        mContext = context;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Observable&lt;R&gt; <span class="title">call</span><span class="params">(Observable&lt;T&gt; observable)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> observable</div><div class="line">                .compose(<span class="keyword">new</span> SchedulerTransformer&lt;T&gt;())</div><div class="line">                .compose(<span class="keyword">new</span> ErrorCheckerTransformer&lt;T, R&gt;(mContext));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Subscriber"><a href="#Subscriber" class="headerlink" title="Subscriber"></a>Subscriber</h2><p>为了进一步统一错误消息的展示方式，我们又对 <code>Subscriber</code> 进行了一层封装。</p>
<h3 id="BaseSubscriber"><a href="#BaseSubscriber" class="headerlink" title="BaseSubscriber"></a>BaseSubscriber</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseSubscriber</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">Subscriber</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">    <span class="keyword">private</span> Context mContext;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BaseSubscriber</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        mContext = context;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Context <span class="title">getContext</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> mContext;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="ToastSubscriber"><a href="#ToastSubscriber" class="headerlink" title="ToastSubscriber"></a>ToastSubscriber</h3><p>以 Toast 形式展示错误消息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ToastSubscriber</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">BaseSubscriber</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ToastSubscriber</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@CallSuper</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line">        ToastUtil.show(getContext(), e.getMessage());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="DialogSubscriber"><a href="#DialogSubscriber" class="headerlink" title="DialogSubscriber"></a>DialogSubscriber</h3><p>以 Dialog 形式展示错误消息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">DialogSubscriber</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">BaseSubscriber</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DialogSubscriber</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@CallSuper</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line">        DialogUtil.showDialog(getContext(), e.getMessage(), <span class="string">"OK"</span>, <span class="keyword">true</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="如何使用"><a href="#如何使用" class="headerlink" title="如何使用"></a>如何使用</h2><p>我们以获取 Category 为例来说明如何利用 Retrofit 和 RxAndroid 来改写现有模块。</p>
<h3 id="1-定义-CategoryResponse"><a href="#1-定义-CategoryResponse" class="headerlink" title="1. 定义 CategoryResponse"></a>1. 定义 CategoryResponse</h3><p><code>CategoryResponse</code> 必须继承自 <code>BaseResponse</code>，里面包含了错误信息的数据结构。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Keep</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CategoryResponse</span> <span class="keyword">extends</span> <span class="title">BaseResponse</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> Response response;</div><div class="line"></div><div class="line">    <span class="meta">@Keep</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Response</span> </span>&#123;</div><div class="line">        <span class="keyword">public</span> List&lt;Category&gt; categories;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其中 <code>Category</code> 是具体的实体类型。</p>
<h3 id="2-定义-Service-Method"><a href="#2-定义-Service-Method" class="headerlink" title="2. 定义 Service Method"></a>2. 定义 Service Method</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TradesService</span> </span>&#123;</div><div class="line">    <span class="meta">@GET</span>(<span class="string">"api.tradecategories/1.0.0/get"</span>)</div><div class="line">    Observable&lt;Response&lt;CategoryResponse&gt;&gt; tradeCategories();</div></pre></td></tr></table></figure>
<p><strong>注意点</strong></p>
<ul>
<li><code>TradesService</code> 必须是一个 <code>interface</code>，而且不能继承其他 <code>interface</code>。</li>
<li><code>tradeCategories</code> 的返回值必须是  <code>Observable&lt;Response&lt;? extends BaseResponse&gt;&gt;</code> 类型。</li>
</ul>
<h3 id="3-利用-ServiceFactory-创建一个-TradeService-实例"><a href="#3-利用-ServiceFactory-创建一个-TradeService-实例" class="headerlink" title="3. 利用 ServiceFactory 创建一个  TradeService 实例"></a>3. 利用 ServiceFactory 创建一个  TradeService 实例</h3><p>在适当的时机（<code>Activity#onCreate</code>、<code>Fragment#onViewCreated</code> 等）根据网关类型通过 <code>ServiceFactory</code> 创建一个 <code>TradeService</code> 实例。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mTradesService = ServiceFactory.createNewService(TradesService.class)</div></pre></td></tr></table></figure>
<h3 id="4-TradeService-获取数据"><a href="#4-TradeService-获取数据" class="headerlink" title="4. TradeService 获取数据"></a>4. TradeService 获取数据</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">mTradesService.tradeCategories()</div><div class="line">        .compose(<span class="keyword">new</span> DefaultTransformer&lt;Response&lt;CategoryResponse&gt;, CategoryResponse&gt;(getActivity()))</div><div class="line">        .map(<span class="keyword">new</span> Func1&lt;CategoryResponse, List&lt;Category&gt;&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> List&lt;Category&gt; <span class="title">call</span><span class="params">(CategoryResponse response)</span> </span>&#123;</div><div class="line">                <span class="keyword">return</span> response.response.categories;</div><div class="line">            &#125;</div><div class="line">        &#125;)</div><div class="line">        .flatMap(<span class="keyword">new</span> Func1&lt;List&lt;Category&gt;, Observable&lt;Category&gt;&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> Observable&lt;Category&gt; <span class="title">call</span><span class="params">(List&lt;Category&gt; categories)</span> </span>&#123;</div><div class="line">                <span class="keyword">return</span> Observable.from(categories);</div><div class="line">            &#125;</div><div class="line">        &#125;)</div><div class="line">        .subscribe(<span class="keyword">new</span> ToastSubscriber&lt;Category&gt;(getActivity) &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</div><div class="line">                hideProgressBar();</div><div class="line">                <span class="comment">// business related code</span></div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line">                <span class="keyword">super</span>.onError(e);</div><div class="line">                hideProgressBar();</div><div class="line">                <span class="comment">// business related code</span></div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Category category)</span> </span>&#123;</div><div class="line">                <span class="comment">// business related code</span></div><div class="line">            &#125;</div><div class="line">        &#125;);</div></pre></td></tr></table></figure>
<p>注意：<code>DefaultTransformer</code> 包含了<strong>线程分配</strong>和<strong>错误处理</strong>两部分功能，所以调用方只需要关心正确的数据就可以了。</p>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><h3 id="NetworkBehavior-网络环境模拟"><a href="#NetworkBehavior-网络环境模拟" class="headerlink" title="NetworkBehavior - 网络环境模拟"></a>NetworkBehavior - 网络环境模拟</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">givenNetworkFailurePercentIs</span><span class="params">(<span class="keyword">int</span> failurePercent)</span> </span>&#123;</div><div class="line">    mNetworkBehavior.setDelay(<span class="number">0</span>, TimeUnit.MILLISECONDS);</div><div class="line">    mNetworkBehavior.setVariancePercent(<span class="number">0</span>);</div><div class="line">    mNetworkBehavior.setFailurePercent(failurePercent);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="TestSubscriber-带断言的-Subscriber"><a href="#TestSubscriber-带断言的-Subscriber" class="headerlink" title="TestSubscriber - 带断言的 Subscriber"></a>TestSubscriber - 带断言的 Subscriber</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> TestSubscriber&lt;Response&lt;CategoryResponse&gt;&gt; mTestSubscriberCategory = TestSubscriber.create()</div><div class="line">subscriber.assertError(RuntimeException.class);</div><div class="line">subscriber.assertNotCompleted();</div></pre></td></tr></table></figure>
<h3 id="MockRetrofit-为-Retrofit-添加-Mock-数据（NetworkBehavior-等）"><a href="#MockRetrofit-为-Retrofit-添加-Mock-数据（NetworkBehavior-等）" class="headerlink" title="MockRetrofit - 为 Retrofit 添加 Mock 数据（NetworkBehavior 等）"></a>MockRetrofit - 为 Retrofit 添加 Mock 数据（NetworkBehavior 等）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Before</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> </span>&#123;</div><div class="line">    Retrofit retrofit = <span class="keyword">new</span> Retrofit.Builder()</div><div class="line">            .addConverterFactory(GsonConverterFactory.create())</div><div class="line">            .addCallAdapterFactory(RxJavaCallAdapterFactory.create())</div><div class="line">            .baseUrl(ServiceFactory.CARMEN_BASE_URL)</div><div class="line">            .build();</div><div class="line"></div><div class="line">    MockRetrofit mockRetrofit = <span class="keyword">new</span> MockRetrofit.Builder(retrofit)</div><div class="line">            .networkBehavior(mNetworkBehavior)</div><div class="line">            .build();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="BehaviorDelegate-Retrofit-Service-的代理，用于产生-Mock-数据"><a href="#BehaviorDelegate-Retrofit-Service-的代理，用于产生-Mock-数据" class="headerlink" title="BehaviorDelegate - Retrofit Service 的代理，用于产生 Mock 数据"></a>BehaviorDelegate - Retrofit Service 的代理，用于产生 Mock 数据</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">BehaviorDelegate&lt;TradesService&gt; delegate = mockRetrofit.create(TradesService.class);</div><div class="line">mTradesServiceMock = <span class="keyword">new</span> TradesServiceMock(delegate);</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TradesServiceMock</span> <span class="keyword">implements</span> <span class="title">TradesService</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BehaviorDelegate&lt;TradesService&gt; mDelegate;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TradesServiceMock</span><span class="params">(BehaviorDelegate&lt;TradesService&gt; delegate)</span> </span>&#123;</div><div class="line">        mDelegate = delegate;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> Observable&lt;Response&lt;CategoryResponse&gt;&gt; tradeCategories() &#123;</div><div class="line">        <span class="keyword">return</span> mDelegate.returningResponse(<span class="string">"&#123;\"error_response\": \"my god\"&#125;"</span>).tradeCategories();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>通过以上实践可以看出，Retrofit + RxAndroid 大大改善了代码的可维护性。</p>
<ol>
<li>以 API 为中心，Request、Response、Method 一一对应，开发效率飙升</li>
<li>告别 Callback Hell，以同步方式写异步代码，让代码结构更清晰，更易于维护</li>
<li>基于事件，各种 Operator，四两拨千斤，尽情发挥你的想象力。</li>
</ol>
<h2 id="修订"><a href="#修订" class="headerlink" title="修订"></a>修订</h2><p>谢谢 <a href="http://www.jianshu.com/users/ec59bd61433a" target="_blank" rel="external">程序亦非猿</a> 指出，<code>OkHttpClient</code> 修改为单例。</p>
<blockquote>
<p>Most applications should call new OkHttpClient()<br> exactly once, configure it with their cache, and use that same instance everywhere. Otherwise the two cache instances will stomp on each other, corrupt the response cache, and possibly crash your program.</p>
</blockquote>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2016-05-24T13:02:45.000Z"><a href="/2016/05/24/difference-between-application-id-and-package-name/">2016-05-24</a></time>
      
      
  
    <h1 class="title"><a href="/2016/05/24/difference-between-application-id-and-package-name/">ApplicationId 与 PackageName 的区别</a></h1>
  

    </header>
    <div class="entry">
      
        <p>在 <code>Android Gradle Build System</code> 之前，<code>PackageName</code> 就是 App 的进程 id。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line">    <span class="attr">package</span>=<span class="string">"com.example.my.app"</span></div><div class="line">    <span class="attr">android:versionCode</span>=<span class="string">"1"</span></div><div class="line">    <span class="attr">android:versionName</span>=<span class="string">"1.0"</span> &gt;</div></pre></td></tr></table></figure>
<p>此处的 package 属性有两个用途：</p>
<ol>
<li>App 的进程 ID</li>
<li><code>R</code> 的包名以及 Manifest 中 Activity 等四大组件的相对包名。</li>
</ol>
<p>但是，Android 利用 Gradle 作为 Build System 之后就“起风了”。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">apply <span class="string">plugin:</span> <span class="string">'com.android.application'</span></div><div class="line"></div><div class="line">android &#123;</div><div class="line">    compileSdkVersion <span class="number">19</span></div><div class="line">    buildToolsVersion <span class="string">"19.1"</span></div><div class="line"></div><div class="line">    defaultConfig &#123;</div><div class="line">        applicationId <span class="string">"com.example.my.app"</span></div><div class="line">        minSdkVersion <span class="number">15</span></div><div class="line">        targetSdkVersion <span class="number">19</span></div><div class="line">        versionCode <span class="number">1</span></div><div class="line">        versionName <span class="string">"1.0"</span></div><div class="line">    &#125;</div><div class="line">    ...</div></pre></td></tr></table></figure>
<p><code>com.android.application</code> 插件的 <code>android</code> 这个 DSL container 中定义了一个 <code>applicationId</code>，这个 <code>applicationId</code> 取代 package name 成为 App 的进程 id。</p>
<p>不同的 flavor 或者 build type 可以拥有不同的 application id，也就是不同的进程 id。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">productFlavors &#123;</div><div class="line">    pro &#123;</div><div class="line">        applicationId = <span class="string">"com.example.my.pkg.pro"</span></div><div class="line">    &#125;</div><div class="line">    free &#123;</div><div class="line">        applicationId = <span class="string">"com.example.my.pkg.free"</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">buildTypes &#123;</div><div class="line">    debug &#123;</div><div class="line">        applicationIdSuffix <span class="string">".debug"</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">....</div></pre></td></tr></table></figure>
<p>所以，application id 与 package name 分工明确。</p>
<ol>
<li><strong>application id</strong> 负责 App 的进程 ID</li>
<li><strong>package name</strong> 负责 <code>R</code> 的包名以及 Manifest 中 Activity 等四大组件的相对包名</li>
</ol>
<p>如果 build.gradle 中没有指定 <code>applicationId</code>，那么 application id 的默认值就是 <code>manifest</code> 的 <code>package</code> 属性值。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="http://tools.android.com/tech-docs/new-build-system/applicationid-vs-packagename" target="_blank" rel="external">ApplicationId versus PackageName</a></li>
</ul>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>





<nav id="pagination">
  
  
    <a href="/page/2/" class="alignright next">下一页</a>
  
  <div class="clearfix"></div>
</nav></div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="搜索">
    <input type="hidden" name="q" value="site:liangfei.me">
  </form>
</div>

  

  
<div class="widget tagcloud">
  <h3 class="title">标签云</h3>
  <div class="entry">
    <a href="/tags/Android/" style="font-size: 20px;">Android</a> <a href="/tags/Git/" style="font-size: 13.33px;">Git</a> <a href="/tags/Hybrid/" style="font-size: 13.33px;">Hybrid</a> <a href="/tags/Japanese/" style="font-size: 10px;">Japanese</a> <a href="/tags/Java/" style="font-size: 16.67px;">Java</a> <a href="/tags/Retrofit/" style="font-size: 13.33px;">Retrofit</a> <a href="/tags/RxJava/" style="font-size: 10px;">RxJava</a> <a href="/tags/iOS/" style="font-size: 10px;">iOS</a> <a href="/tags/工具/" style="font-size: 10px;">工具</a> <a href="/tags/生活/" style="font-size: 16.67px;">生活</a> <a href="/tags/车/" style="font-size: 10px;">车</a>
  </div>
</div>


  
<div class="widget tag">
  <h3 class="title">最新文章</h3>
  <ul class="entry">
    
      <li>
        <a href="/2016/07/20/the-weird-NoClassDefFoundError/">诡异的问题 NoClassDefFoundError</a>
      </li>
    
      <li>
        <a href="/2016/07/17/一切唯心造/">一切唯心造</a>
      </li>
    
      <li>
        <a href="/2016/07/10/diagram-retrofit-service-method/">图解 Retrofit 之 ServiceMethod</a>
      </li>
    
      <li>
        <a href="/2016/07/06/my-practice-with-retrofit-and-rxjava/">Retrofit + RxAndroid 实践总结</a>
      </li>
    
      <li>
        <a href="/2016/05/24/difference-between-application-id-and-package-name/">ApplicationId 与 PackageName 的区别</a>
      </li>
    
  </ul>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2016 liangfei
  
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>


<script type="text/javascript">
var disqus_shortname = 'liangfeizc';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>