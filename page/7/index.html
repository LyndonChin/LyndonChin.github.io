<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>第 7 页 | 梁飞</title>
  <meta name="author" content="liangfei">
  
  <meta name="description" content="梁飞的个人博客">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="梁飞"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="梁飞" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  

</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">梁飞</a></h1>
  <h2><a href="/">行有不得反求诸己</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
      <li><a href="/about">About</a></li>
    
    <li><a href="https://github.com/lyndonchin">Github</a></li>
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper">
  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2015-06-23T08:47:40.000Z"><a href="/2015/06/23/dpi-dp-sp/">2015-06-23</a></time>
      
      
  
    <h1 class="title"><a href="/2015/06/23/dpi-dp-sp/">详解 Android 开发中常用的 DPI / DP / SP</a></h1>
  

    </header>
    <div class="entry">
      
        <p>Android的碎片化已经被喷了好多年，随着国内手机厂商的崛起，碎片化也越来越严重，根据<a href="http://thenextweb.com/mobile/2014/08/21/18796-different-android-devices-according-opensignals-latest-fragmentation-report/" target="_blank" rel="external">OpenSignal的最新调查</a>，2014年市面上有18796种不同的Android设备，作为开发者，一个无法回避的难题就是需要适配各种各样奇奇怪怪的机型。</p>
<p>设备机型不同必然也会导致屏幕大小和分辨率（Resolution）的不同，但是无论分辨率有多大，屏幕有多大，我们手指触控范围的大小不会发生变化，所以最优的适配方式应该是<strong>指定大小的控件在所有的设备上的显示都一样</strong>。</p>
<p>Android的官方文档对此也有明确的说明</p>
<blockquote>
<p>When adding support for multiple screens, applications <em>do not work directly with resolution</em>; applications should be concerned <em>only with screen size and density</em>, as specified by the generalized size and density groups.</p>
</blockquote>
<p>所以，适配应该与分辨率无关，只与屏幕大小和屏幕密度相关，首先来看一下什么是屏幕密度 － DPI。</p>
<h3 id="DPI"><a href="#DPI" class="headerlink" title="DPI"></a>DPI</h3><p>DPI的全称是 Dots Per Inch，Inch是一个物理单位（无论在任何设备上，其大小都是固定的），所以DPI就指在一个Inch的物理长度内有多少个Dot，160DPI的屏幕就表示一个Inch包含160个Dot，320DPI的屏幕表示一个Inch有320个Dot，所以说Dot的大小是不固定的。</p>
<p>Android设备用DPI来表示屏幕密度(Density)，屏幕密度大就表示一个Inch包含的Dot比较多。那PPI是什么呢？<br>我们会经常看到iPad、iPhone是用PPI来表示屏幕密度，小米Pad也是用PPI来表示。<br><img src="http://img4.tbcdn.cn/L1/461/1/ffa8ab85d4cc4d9e8b9cb379143bb83bcaf40a28" alt="PPI in mi pad"></p>
<p>其实对Android而言，DPI等价于PPI(Pixels-Per-Inch)，DPI最早是用于印刷行业，跟PPI还是有本质不同的，Android应该是误用了DPI这个概念。具体可以参考<a href="http://99designs.com/designer-blog/2013/02/26/ppi-vs-dpi-whats-the-difference/" target="_blank" rel="external">PPI vs. DPI: what’s the difference?</a>。</p>
<p>其实我们只要知道在Android设备中，DPI 等价于 PPI 就可以了。<br><img src="http://img2.tbcdn.cn/L1/461/1/73e824419477f8c604791f6318f8a4701c91d165" alt="PPI 定义"></p>
<p>通常我们说一个设备是多少寸时，指的是屏幕对角线(Diagonal)是多少inch，所以用对角线的像素值（px）除以对角线长度（inch），就可以计算出PPI。<br><img src="http://img1.tbcdn.cn/L1/461/1/af31a9366de3232f78a9e48904f5b0463875ec25" alt="PPI 计算公式"></p>
<p>为了简化适配工作，Android根据屏幕大小（Inch）和屏幕密度（DPI）对设备做了如下划分：<br><img src="http://img1.tbcdn.cn/L1/461/1/5a7fe24f76a7f23cbdea5efa088b1188d73597f5" alt="PPI 对应屏幕尺寸"></p>
<h3 id="DP"><a href="#DP" class="headerlink" title="DP"></a>DP</h3><p>既然有那么多不同分辨率、不同大小的屏幕，使用PX必然会导致适配困难，为了进一步简化适配工作，Android为我们提供了一个虚拟的像素单位 － DP 或者 DIP (Density-Independent pixel)，当然也可以理解为 Device-Independent Pixel。为什么说是<strong>虚拟</strong>呢，因为它的大小不是一个物理（Phisical）值，而是由操作系统根据屏幕大小和密度动态渲染出来的。</p>
<p>PX跟DP之间的换算关系很简单 </p>
<blockquote>
<p> px = dp * (dpi / 160)</p>
</blockquote>
<p>举例来说，小米Pad的屏幕密度为326dpi，如果需要显示的图片大小为20dp，那么就需要提供一个 <code>20 <em> (326 / 160) = 40px</em></code>的图片才能达到最佳显示效果，如果还要适配一个163dpi的屏幕，那么还需要再提供一个<code>20  (163 / 160) = 20px</code>的图片。</p>
<p>那么一个20dp的图片，在不同设备上的显示效果如何呢？我们以iPad为例来说明。<br><img src="http://img4.tbcdn.cn/L1/461/1/2c18879aebe47f6faa42c3f3d2e21ccc7e77d66d" alt="iPad 屏幕参数"></p>
<p>iPad2 和 iPad Retina的物理尺寸都是 9.7 inch，不同的是分辨率和PPI，一个是1024x768 / 132ppi，另一个是2048x1536 / 264ppi，</p>
<p>分别计算一下20dp对应多少inch</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ipad2 = <span class="number">20</span> * (<span class="number">132</span> / <span class="number">160</span>) * (<span class="number">7.9</span> / (math.sqrt(<span class="number">1024</span> * <span class="number">1024</span> + <span class="number">768</span> * <span class="number">768</span>))) </div><div class="line">ipad_retina = <span class="number">20</span> * (<span class="number">264</span> / <span class="number">160</span>) * (<span class="number">7.9</span> / (math.sqrt(<span class="number">2048</span> * <span class="number">2048</span> + <span class="number">1536</span> * <span class="number">1536</span>)))</div></pre></td></tr></table></figure>
<p>计算结果都是0.1018359375，这就是dp的功能，它能保证在所有的设备上显示的大小都一样。</p>
<p>如果只提供了一个大小为20px的图片，为了保证图片在所有设备上的物理大小都一样，高DPI的设备上系统会拉伸图片，低DPI的设备上图片会被缩小，这样既会影响UE也会影响APP的执行效率。所以我们需要为不同屏幕密度的设备提供不同的图片，他们之间的对应关系如下。<br><img src="http://img1.tbcdn.cn/L1/461/1/7d691bde9a6f414a5f93082b0312c1589289494d" alt="Android 设备屏幕分级"></p>
<p>我们在用Sketch作图的时候，如果1x图片对应的是屏幕是MDPI (160dpi)，那么1.5x，2x就分别对应HDPI，XHDPI。<br><img src="http://img4.tbcdn.cn/L1/461/1/4c46ea76d3cf05a87bdf101ac931a1d00ff730ef" alt="screens_densities"></p>
<h3 id="SP"><a href="#SP" class="headerlink" title="SP"></a>SP</h3><p>SP 全称是 Scale-independent Pixels，用于字体大小，其概念与DP是一致的，也是为了保持设备无关。因为Android用户可以根据喜好来调整字体大小，所以要使用sp来表示字体大小。<br><img src="http://img4.tbcdn.cn/L1/461/1/ed1118ab7e089febd541bd8f1ed454e009edec24" alt="changing_android_font_size"></p>
<h3 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h3><ol>
<li><a href="http://developer.android.com/guide/practices/screens_support.html#DeclaringTabletLayouts" target="_blank" rel="external">http://developer.android.com/guide/practices/screens_support.html#DeclaringTabletLayouts</a></li>
<li><a href="http://developer.android.com/training/multiscreen/screendensities.html" target="_blank" rel="external">http://developer.android.com/training/multiscreen/screendensities.html</a></li>
<li><a href="http://stackoverflow.com/questions/2025282/difference-between-px-dp-dip-and-sp-in-android" target="_blank" rel="external">http://stackoverflow.com/questions/2025282/difference-between-px-dp-dip-and-sp-in-android</a></li>
<li><a href="http://99designs.com/designer-blog/2013/02/26/ppi-vs-dpi-whats-the-difference" target="_blank" rel="external">http://99designs.com/designer-blog/2013/02/26/ppi-vs-dpi-whats-the-difference</a></li>
</ol>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>





  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2015-06-19T16:00:00.000Z"><a href="/2015/06/20/how-to-get-the-hardware-data-of-android-device/">2015-06-20</a></time>
      
      
  
    <h1 class="title"><a href="/2015/06/20/how-to-get-the-hardware-data-of-android-device/">如何获取 Android 设备的CPU核数、时钟频率以及内存大小</a></h1>
  

    </header>
    <div class="entry">
      
        <p>因项目需要，分析了一下 Facebook 的开源项目 - <a href="https://github.com/facebook/device-year-class" target="_blank" rel="external">Device Year Class</a>。</p>
<p><strong>Device Year Class</strong> 的主要功能是根据 <em>CPU核数</em>、<em>时钟频率</em> 以及 <em>内存大小</em> 对设备进行分级。代码很简单，只包含两个类:</p>
<ul>
<li><code>DeviceInfo</code> -&gt; 获取设备参数，</li>
<li><code>YearClass</code> -&gt; 根据参数进行分级。</li>
</ul>
<p>下表是 Facebook 公司提供的<a href="https://github.com/facebook/device-year-class/blob/master/README.md" target="_blank" rel="external">分级标准</a>，其中 <code>Year</code> 栏表示分级结果。</p>
<table>
<thead>
<tr>
<th style="text-align:right">Year</th>
<th style="text-align:right">Cores</th>
<th style="text-align:right">Clock</th>
<th style="text-align:right">RAM</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right">2008</td>
<td style="text-align:right">1</td>
<td style="text-align:right">528MHz</td>
<td style="text-align:right">192MB</td>
</tr>
<tr>
<td style="text-align:right">2009</td>
<td style="text-align:right">n/a</td>
<td style="text-align:right">600MHz</td>
<td style="text-align:right">290MB</td>
</tr>
<tr>
<td style="text-align:right">2010</td>
<td style="text-align:right">n/a</td>
<td style="text-align:right">1.0GHz</td>
<td style="text-align:right">512MB</td>
</tr>
<tr>
<td style="text-align:right">2011</td>
<td style="text-align:right">2</td>
<td style="text-align:right">1.2GHz</td>
<td style="text-align:right">1GB</td>
</tr>
<tr>
<td style="text-align:right">2012</td>
<td style="text-align:right">4</td>
<td style="text-align:right">1.5GHz</td>
<td style="text-align:right">1.5GB</td>
</tr>
<tr>
<td style="text-align:right">2013</td>
<td style="text-align:right">n/a</td>
<td style="text-align:right">2.0GHz</td>
<td style="text-align:right">2GB</td>
</tr>
<tr>
<td style="text-align:right">2014</td>
<td style="text-align:right">n/a</td>
<td style="text-align:right">&gt;2GHz</td>
<td style="text-align:right">&gt;2GB</td>
</tr>
</tbody>
</table>
<p>关于输出年份的计算方法可以参考<a href="https://github.com/facebook/device-year-class" target="_blank" rel="external">源码</a>，本文只把一些比较常用的功能抽取出来做一个简要介绍。</p>
<h2 id="获取-CPU-核数"><a href="#获取-CPU-核数" class="headerlink" title="获取 CPU 核数"></a>获取 CPU 核数</h2><p>我们都知道，Linux 中的设备都是以文件的形式存在，CPU 也不例外，因此 CPU 的文件个数就等价与<strong>核数</strong>。</p>
<p>Android 的 CPU 设备文件位于 <code>/sys/devices/system/cpu/</code> 目录，文件名的的格式为 <code>cpu\d+</code>。</p>
<pre>
root@generic_x86_64:/sys/devices/system/cpu # ls
<b>cpu0</b>
cpufreq
cpuidle
kernel_max
modalias
offline
online
possible
power
present
uevent
</pre>

<p>统计一下文件个数便可以获得 CPU 核数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getNumberOfCPUCores</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">if</span> (Build.VERSION.SDK_INT &lt;= Build.VERSION_CODES.GINGERBREAD_MR1) &#123;</div><div class="line">    <span class="comment">// Gingerbread doesn't support giving a single application access to both cores, but a</span></div><div class="line">    <span class="comment">// handful of devices (Atrix 4G and Droid X2 for example) were released with a dual-core</span></div><div class="line">    <span class="comment">// chipset and Gingerbread; that can let an app in the background run without impacting</span></div><div class="line">    <span class="comment">// the foreground application. But for our purposes, it makes them single core.</span></div><div class="line">    <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">int</span> cores;</div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">    cores = <span class="keyword">new</span> File(<span class="string">"/sys/devices/system/cpu/"</span>).listFiles(CPU_FILTER).length;</div><div class="line">  &#125; <span class="keyword">catch</span> (SecurityException e) &#123;</div><div class="line">    cores = DEVICEINFO_UNKNOWN;</div><div class="line">  &#125; <span class="keyword">catch</span> (NullPointerException e) &#123;</div><div class="line">    cores = DEVICEINFO_UNKNOWN;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> cores;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> FileFilter CPU_FILTER = <span class="keyword">new</span> FileFilter() &#123;</div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">accept</span><span class="params">(File pathname)</span> </span>&#123;</div><div class="line">    String path = pathname.getName();</div><div class="line">    <span class="comment">//regex is slow, so checking char by char.</span></div><div class="line">    <span class="keyword">if</span> (path.startsWith(<span class="string">"cpu"</span>)) &#123;</div><div class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">3</span>; i &lt; path.length(); i++) &#123;</div><div class="line">        <span class="keyword">if</span> (path.charAt(i) &lt; <span class="string">'0'</span> || path.charAt(i) &gt; <span class="string">'9'</span>) &#123;</div><div class="line">          <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">  &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h2 id="获取时钟频率"><a href="#获取时钟频率" class="headerlink" title="获取时钟频率"></a>获取时钟频率</h2><p>获取<strong>时钟频率</strong>需要读取系统文件 - <code>/sys/devices/system/cpu/cpu0/cpufreq/cpuinfo_max_freq</code> 或者 <code>/proc/cpuinfo</code>。</p>
<p>我的 Android 模拟器中并没有 <code>cpuinfo_max_freq</code> 文件，因此只能读取 <code>/proc/cpuinfo</code>。</p>
<p><code>/proc/cpuinfo</code> 包含了很多 cpu 数据。</p>
<pre>
processor    : 0
vendor_id    : GenuineIntel
cpu family    : 6
model        : 70
model name    : Intel(R) Core(TM) i7-4770HQ CPU @ 2.20GHz
stepping    : 1
cpu MHz        : 0.000
cache size    : 1024 KB
fdiv_bug    : no
hlt_bug        : no
f00f_bug    : no
coma_bug    : no
fpu        : yes
fpu_exception    : yes
cpuid level    : 4
wp        : yes
</pre>

<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getCPUMaxFreqKHz</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">int</span> maxFreq = DEVICEINFO_UNKNOWN;</div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; getNumberOfCPUCores(); i++) &#123;</div><div class="line">      String filename =</div><div class="line">          <span class="string">"/sys/devices/system/cpu/cpu"</span> + i + <span class="string">"/cpufreq/cpuinfo_max_freq"</span>;</div><div class="line">      File cpuInfoMaxFreqFile = <span class="keyword">new</span> File(filename);</div><div class="line">      <span class="keyword">if</span> (cpuInfoMaxFreqFile.exists()) &#123;</div><div class="line">        <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">128</span>];</div><div class="line">        FileInputStream stream = <span class="keyword">new</span> FileInputStream(cpuInfoMaxFreqFile);</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">          stream.read(buffer);</div><div class="line">          <span class="keyword">int</span> endIndex = <span class="number">0</span>;</div><div class="line">          <span class="comment">//Trim the first number out of the byte buffer.</span></div><div class="line">          <span class="keyword">while</span> (buffer[endIndex] &gt;= <span class="string">'0'</span> &amp;&amp; buffer[endIndex] &lt;= <span class="string">'9'</span></div><div class="line">              &amp;&amp; endIndex &lt; buffer.length) endIndex++;</div><div class="line">          String str = <span class="keyword">new</span> String(buffer, <span class="number">0</span>, endIndex);</div><div class="line">          Integer freqBound = Integer.parseInt(str);</div><div class="line">          <span class="keyword">if</span> (freqBound &gt; maxFreq) maxFreq = freqBound;</div><div class="line">        &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</div><div class="line">          <span class="comment">//Fall through and use /proc/cpuinfo.</span></div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">          stream.close();</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (maxFreq == DEVICEINFO_UNKNOWN) &#123;</div><div class="line">      FileInputStream stream = <span class="keyword">new</span> FileInputStream(<span class="string">"/proc/cpuinfo"</span>);</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">int</span> freqBound = parseFileForValue(<span class="string">"cpu MHz"</span>, stream);</div><div class="line">        freqBound *= <span class="number">1000</span>; <span class="comment">//MHz -&gt; kHz</span></div><div class="line">        <span class="keyword">if</span> (freqBound &gt; maxFreq) maxFreq = freqBound;</div><div class="line">      &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        stream.close();</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">    maxFreq = DEVICEINFO_UNKNOWN; <span class="comment">//Fall through and return unknown.</span></div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> maxFreq;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="获取内存大小"><a href="#获取内存大小" class="headerlink" title="获取内存大小"></a>获取内存大小</h2><p>如果 SDK 版本大于等于 <code>JELLY_BEAN</code> ，可以通过 <code>ActivityManager</code> 来获取内从大小。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ActivityManager.MemoryInfo memInfo = <span class="keyword">new</span> ActivityManager.MemoryInfo();</div><div class="line">ActivityManager am = (ActivityManager) c.getSystemService(Context.ACTIVITY_SERVICE);</div><div class="line">am.getMemoryInfo(memInfo);</div></pre></td></tr></table></figure>
<p>如果版本低于 <code>JELLY_BEAN</code> ，则只能读取系统文件了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">FileInputStream stream = <span class="keyword">new</span> FileInputStream(<span class="string">"/proc/meminfo"</span>);</div><div class="line">totalMem = parseFileForValue(<span class="string">"MemTotal"</span>, stream);</div></pre></td></tr></table></figure>
<p>完整代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@TargetApi</span>(Build.VERSION_CODES.JELLY_BEAN)</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">getTotalMemory</span><span class="params">(Context c)</span> </span>&#123;</div><div class="line">  <span class="comment">// memInfo.totalMem not supported in pre-Jelly Bean APIs.</span></div><div class="line">  <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.JELLY_BEAN) &#123;</div><div class="line">    ActivityManager.MemoryInfo memInfo = <span class="keyword">new</span> ActivityManager.MemoryInfo();</div><div class="line">    ActivityManager am = (ActivityManager) c.getSystemService(Context.ACTIVITY_SERVICE);</div><div class="line">    am.getMemoryInfo(memInfo);</div><div class="line">    <span class="keyword">if</span> (memInfo != <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">return</span> memInfo.totalMem;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      <span class="keyword">return</span> DEVICEINFO_UNKNOWN;</div><div class="line">    &#125;</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="keyword">long</span> totalMem = DEVICEINFO_UNKNOWN;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      FileInputStream stream = <span class="keyword">new</span> FileInputStream(<span class="string">"/proc/meminfo"</span>);</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        totalMem = parseFileForValue(<span class="string">"MemTotal"</span>, stream);</div><div class="line">        totalMem *= <span class="number">1024</span>;</div><div class="line">      &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        stream.close();</div><div class="line">      &#125;</div><div class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> totalMem;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>





  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2015-05-04T16:00:00.000Z"><a href="/2015/05/05/introduction-to-sky/">2015-05-05</a></time>
      
      
  
    <h1 class="title"><a href="/2015/05/05/introduction-to-sky/">Dart更近一步，Sky会一统江湖吗？</a></h1>
  

    </header>
    <div class="entry">
      
        <p>从接触编程到现在，除了搞过几天JQuery，几乎没怎么写过Javascript，刚刚看了两篇介绍 ECMAScript6 的文章，突然觉得没写过JS也没什么好遗憾的。</p>
<ul>
<li><a href="https://hacks.mozilla.org/2015/04/es6-in-depth-an-introduction/" target="_blank" rel="external">ES6 In Depth: An Introduction</a></li>
<li><a href="https://hacks.mozilla.org/2015/04/es6-in-depth-iterators-and-the-for-of-loop/" target="_blank" rel="external">ES6 In Depth: Iterators and the for-of loop</a></li>
</ul>
<p>ES6 好像从2009年就开始制定了，现在终于支持 <code>forEach</code>、<code>for-in</code>等操作，也支持<code>Map</code>、<code>Set</code>等数据类型，而且为了考虑兼容性问题居然引入了一个 <code>for-of</code>，不过看到 <a href="http://githut.info/" target="_blank" rel="external">Githut</a> 上关于 github 语言的统计数据，不得不佩服JS社区强大的生产力。</p>
<p>话说回来，Dart 作为一个崭新的语言，自诞生那天起就抛去了向下兼容的历史包袱，而且可以直接转成 Javascript，Chrome 的 V8 团队还专门为 Dart 做了一个虚拟机 - Dartium。</p>
<p>Dart 目的跟 Node 一样，也是为了统一前后端开发，这一点在上一篇文章 （<a href="http://blog.csdn.net/feelang/article/details/45469151" target="_blank" rel="external">Dart是一个怎样的语言？</a> ）已经说过了，所以用 Dart 做 web 开发也没有额外的学习成本，当然前提是你得会写 Dart。</p>
<p>官方教程提供的一个简单的 web 开发教程 - <a href="https://www.dartlang.org/codelabs/darrrt/" target="_blank" rel="external">Avast, Ye Pirates: Write a Web App</a>，用<code>DartEditor</code>导入后，工程结构如下图所示：</p>
<p><img width="50%" src="http://img.blog.csdn.net/20150504224927710"></p>
<p>有css，有html，一个最简单的web工程（没有后端），在 <code>DartEditor</code> 中可以用两种方式来运行这个工程。</p>
<p><img width="50%" src="http://img.blog.csdn.net/20150504225320675"></p>
<p>如果选择了 <code>Dartium</code>，编译成功后会唤起一个使用了 Dartium 引擎的 chrome 浏览器，而过选择了 <code>Run as JavaScript</code> 就会先把 dart 编译成 js 的工程（工程结构图中灰色的部分），然后唤起一个使用了 V8 引擎的 chrome 浏览器。</p>
<p>其实用 Dart 做开发还是挺方便的，js 都是可以直接拿来用的，但是社区不成熟，不像 node 社区那样有那么多的库。</p>
<hr>
<p>我们再来看看下一代 Android 开发框架 - <a href="https://github.com/domokit" target="_blank" rel="external">sky</a>，今天照着 readme 玩了一下官方提供的几个demo，流畅度可以跟 native 媲美，但是需要从网络加载代码，所以启动时间比较慢，毕竟只是一个实验版本，像 react-native 那样做个本地缓存也不会有什么问题。</p>
<p>整个开发过程与上面的 web 开发非常相似，只不过代码文件的后缀名换了而已。</p>
<p>首先需要创建一个 <code>pubspec.yaml</code>，类似于 Node 的 <code>package.json</code> 或者 gradle 脚本的 <code>build.gradle</code>，主要是一些包依赖关系和 APP 的基本信息，最后一行表示依赖最新版本的 sky。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="attr">name:</span> your_app_name</div><div class="line"><span class="attr">dependencies:</span></div><div class="line"><span class="attr"> sky:</span> any</div></pre></td></tr></table></figure>
<p>在当前目录下执行 <code>pub get</code>，会根据 <code>pubspec.yaml</code> 的依赖配置获取 APP 所依赖的包。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">➜  widgets git:(master) ✗ pub get</div><div class="line">Resolving dependencies... (1.7s)</div><div class="line">+ mojo 0.0.5+dart-summit-1</div><div class="line">+ sky 0.0.5+dart-summit-7</div><div class="line">Changed 2 dependencies!</div><div class="line">➜  widgets git:(master) ✗</div></pre></td></tr></table></figure>
<p>执行完毕后会发现在本地多了一个 <code>package</code> 文件夹，里面有刚刚下载的两个包。</p>
<p><img src="http://img.blog.csdn.net/20150505003910350" alt="这里写图片描述"></p>
<p><em>pub会首先把下载来的包缓存到本地，如果有的新的下载可以直接引用之前下载过的包。</em></p>
<p>sky 我们都知道了，它就是 Android 全新的开发框架，由两部分组成：</p>
<pre>
<i>The Sky engine</i>. The engine is the core of the system. Written in C++, the engine provides the muscle of the Sky system. The engine provides several primitives, including a soft real-time scheduler and a hierarchial, retained-mode graphics system, that let you build high-quality apps.

<i>The Sky framework</i>. The framework makes it easy to build apps using Sky by providing familiar user interface widgets, such as buttons, infinite lists, and animations, on top of the engine using Dart. These extensible components follow a functional programming style inspired by React.
</pre>

<p>简单来说，<em>Sky engine</em> 是一个图形系统，VDOM 的创建和diff应该也是它负责的，而 <em>Sky framework</em> 则是一个UI库，提供了我们创建 VDOM 时所需的节点元素。</p>
<p>那 mojo 又是什么呢？</p>
<pre>Mojo is an effort to extract a common platform out of Chrome's renderer and plugin processes that can support multiple types of sandboxed content, such as HTML, Pepper, or NaCl.</pre>

<p>简单来说，mojo 就是 sky 的运行时环境，但是 domokit 下还有一个<a href="https://github.com/domokit/mojo_sdk" target="_blank" rel="external">mojo-sdk</a>，这个 sdk 为我们提供给了基于 mojo 做二次开发所用到的 API。</p>
<pre>The Mojo Public API is a binary stable API to the Mojo system.</pre>

<p>它支持很多种语言，目前为止包括 <code>C</code>、<code>CPP</code>、<code>Dart</code>、<code>Go</code>、<code>Java</code>、<code>js</code>。</p>
<p>也就是说，Google 想打造的是这样一个生态系统。</p>
<img src="/2015/05/05/introduction-to-sky/dart.png" alt="sky framework" title="sky framework">
<hr>
<p>如果这个愿景能够实现，120fps的卖点也许会一统江湖，但是 Google IO 2015 根本没有提及这个项目，希望 Google 不是玩票 :(</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>





  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2015-05-03T16:00:00.000Z"><a href="/2015/05/04/introduction-to-dart/">2015-05-04</a></time>
      
      
  
    <h1 class="title"><a href="/2015/05/04/introduction-to-dart/">Dart是一个怎样的语言</a></h1>
  

    </header>
    <div class="entry">
      
        <p>这几天看到一篇新闻 - <a href="http://36kr.com/p/532461.html" target="_blank" rel="external">白兼容了？Google 正在为 Android 准备一个去 Java 化的 Dart 应用运行框架</a>，对与新闻的标题和内容无力吐槽，不做评论。但是Google推出 <a href="https://github.com/domokit/sky_sdk" target="_blank" rel="external">sky</a> 似乎证明了native的开发方式越来越向web方式靠近的趋势，最近比较火的要数 <a href="https://github.com/facebook/react-native" target="_blank" rel="external">react-native</a> 了，他们的原理是类似的，都是先构造一个 <em>virtual dom tree</em>，然后只更新发生变化的 dom。sky 的 readme 也说自己参考了 <a href="https://github.com/facebook/react" target="_blank" rel="external">react</a>，那两者最大的区别应该是开发语言了，react-native 是 javascript，而 Google 用的是自己的亲儿子 - <a href="https://www.dartlang.org/" target="_blank" rel="external">Dart</a>。</p>
<p><img src="http://img.blog.csdn.net/20150504004814626" alt="The Sky framework"></p>
<p>Node.js 推出后统一了前后端，如今 node 开发真可谓炙手可热。Google 当初推出 Dart 也是为了统一前后端开发，但是这两年一直不温不火，好像国内使用 <a href="https://github.com/Polymer/polymer" target="_blank" rel="external">Polymer</a> 的开发者也不多，现在用 突然宣布说用 Dart 替换 Android 的开发语言 java，而且还举办了第一个第一届 <a href="https://www.dartlang.org/events/2015/summit/" target="_blank" rel="external">Dart Developer Summit</a>，看来 Google 准备在 Dart 上发力了，相信 Dart 会是五月底 Google IO 大会上的一个重要议题。<br>趁着今天放假，跟着 <a href="https://www.dartlang.org/codelabs/darrrt/" target="_blank" rel="external">Dart 官网的教程</a>玩了一下 Dart，发现 Dart 这门语言确实不错。</p>
<hr>
<h2 id="引用包"><a href="#引用包" class="headerlink" title="引用包"></a>引用包</h2><p>包的引用方式与 Python 和 Go 类似，都是用 <code>import</code>：<br><figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> <span class="string">'dart:html'</span>;</div></pre></td></tr></table></figure></p>
<p>不过只导入包的某个组件的方式比较特殊：<br><figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> <span class="string">'dart:math'</span> show Random;</div><div class="line"><span class="keyword">import</span> <span class="string">'dart:convert'</span> show JSON;</div><div class="line"><span class="keyword">import</span> <span class="string">'dart:async'</span> show Future;</div></pre></td></tr></table></figure></p>
<hr>
<h2 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h2><p><s>Dart 与 Python 一样是一个强类型语言</s>。</p>
<p>Dart 的变量类型是可选的，叫做 static type annotations。</p>
<pre>
Dart’s optional types are static type annotations that act as documentation, clearly expressing your intent.
</pre>

<figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> Random indexGen = <span class="keyword">new</span> Random();</div><div class="line"><span class="built_in">String</span> _firstName;</div><div class="line"><span class="built_in">String</span> _appellation;</div></pre></td></tr></table></figure>
<p>Dart 没有 <code>private</code> 关键字，如果变量或方法是私有类型，需要在名称前面加上下划线。</p>
<p><strong>私有变量</strong><br><figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">PirateName</span> </span>&#123;</div><div class="line">  # ...</div><div class="line">  <span class="built_in">String</span> _firstName;</div><div class="line">  <span class="built_in">String</span> _appellation;</div><div class="line">  # ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>私有方法</strong><br><figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> _parsePirateNamesFromJSON(<span class="built_in">String</span> jsonString) &#123;</div><div class="line">  <span class="built_in">Map</span> pirateNames = JSON.decode(jsonString);</div><div class="line">  names = pirateNames[<span class="string">'names'</span>];</div><div class="line">  appellations = pirateNames[<span class="string">'appellations'</span>];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<hr>
<h2 id="类型转换"><a href="#类型转换" class="headerlink" title="类型转换"></a>类型转换</h2><p>Dart 用关键字 <code>as</code> 来做类型转换。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> updateBadge(Event e) &#123;</div><div class="line">  <span class="built_in">String</span> inputName = (e.target <span class="keyword">as</span> InputElement).value;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<h2 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h2><p>对于某些特定方法，Dart 提供了语法糖，写法很简单。例如，表达式的值即为返回值的情况，可以这么写：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">String</span> toString() =&gt; pirateName;</div></pre></td></tr></table></figure>
<p>不用写成这样：<br><figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">String</span> toString() &#123;</div><div class="line">  <span class="keyword">return</span> pirateName;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>如果是 <code>get</code> 方法，可以直接在返回值类型和方法名之间加上一个关键词 <code>get</code>，而且方法名不需要加括号，调用的时候也不需要加括号。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">String</span> <span class="keyword">get</span> jsonString =&gt; JSON.encode(&#123;<span class="string">"f"</span>: _firstName, <span class="string">"a"</span>: _appellation&#125;);</div><div class="line"></div><div class="line"><span class="built_in">String</span> <span class="keyword">get</span> pirateName =&gt;</div><div class="line">    _firstName.isEmpty ? <span class="string">''</span> : <span class="string">'$_firstName the $_appellation'</span>;</div></pre></td></tr></table></figure>
<hr>
<h2 id="级联操作符（-）"><a href="#级联操作符（-）" class="headerlink" title="级联操作符（..）"></a>级联操作符（..）</h2><p>级联操作符（<em>The cascade operator (..)</em>）可以允许在一个成员变量上执行多个操作。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">genButton..disabled = <span class="keyword">false</span></div><div class="line">         ..text = <span class="string">'Aye! Gimme a name!'</span>;</div></pre></td></tr></table></figure>
<p>以上语句就等价于<br><figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">genButton.disabled = <span class="keyword">false</span>;</div><div class="line">genButton.text = <span class="string">'Aye! Gimme a name!'</span>;</div></pre></td></tr></table></figure></p>
<hr>
<h2 id="字符串转换"><a href="#字符串转换" class="headerlink" title="字符串转换"></a>字符串转换</h2><p>Dart 中变量转化成字符串比 Java 方便多了，跟 Python 有一拼，直接在变量名前加上$符号就可以了。<br><figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">'$_firstName the $_appellation'</span>;</div></pre></td></tr></table></figure></p>
<hr>
<h2 id="构造方法"><a href="#构造方法" class="headerlink" title="构造方法"></a>构造方法</h2><p>Dart 支持有名字的构造方法，这一点比 Java 和 Python 都先进。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">PirateName.fromJSON(String jsonString) &#123;</div><div class="line">  Map storedName = JSON.decode(jsonString);</div><div class="line">  _firstName = storedName[&apos;f&apos;];</div><div class="line">  _appellation = storedName[&apos;a&apos;];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里 <code>PirateName.fromJSON</code> 是一个整体，用的时候要写全了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">return new PirateName.fromJSON(storedName);</div></pre></td></tr></table></figure>
<hr>
<h2 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h2><p>跟 Python 一样，Dart 也支持 <em><a href="http://www.diveintopython.net/power_of_introspection/optional_arguments.html" target="_blank" rel="external">Optional and Named Arguments</a></em>，例如参数可以这么写：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">PirateName(&#123;String firstName, String appellation&#125;) &#123;</div><div class="line">  # ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>参数要用一个大括号括起来，应该是需要把参数封装成一个类似于 Python 的 <code>Dictionary</code>。</p>
<p>但是调用的时候不需要传递所有的参数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">new PirateName(firstName: inputName)</div></pre></td></tr></table></figure>
<hr>
<h2 id="泛型"><a href="#泛型" class="headerlink" title="泛型"></a>泛型</h2><p>Dart 支持泛型，这点跟 Java 很像，例如要定义一个 <code>List</code> 变量可以写成这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">static List names = [];</div><div class="line">static List appellations = [];</div></pre></td></tr></table></figure>
<p>如果要写明类型，就需要在 <code>List</code> 后的简括后内加上类型。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">static List&lt;String&gt; names = [];</div><div class="line">static List&lt;String&gt; appellations = [];</div></pre></td></tr></table></figure></p>
<p>关于泛型类型是否像 java 那样支持 <code>super</code>、 <code>extend</code>还没看到，暂时不知道。</p>
<hr>
<h2 id="异步操作"><a href="#异步操作" class="headerlink" title="异步操作"></a>异步操作</h2><p>Dart 语言原生支持异步操作，主要是用两个关键词 <code>await</code> 和 <code>async</code>。<br>例如，如果我们要定义一个异步方法，不需要像 java 那样去 <strong>new Thread</strong>，直接在方法后面加上 <code>async</code> 关键字就OK了，这样调用时，该方法时会直接返回一个 <code>Future</code>，caller 无需等待。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">static Future readyThePirates() async &#123;</div><div class="line">  String path = &apos;piratenames.json&apos;;</div><div class="line">  String jsonString = await HttpRequest.getString(path);</div><div class="line">  _parsePirateNamesFromJSON(jsonString);    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>await</code> 跟 java中的 wait 方法用法一样，表示等待，但是它只能用于 <code>async</code> 的方法中。</p>
<p>例如上面代码片段中， <code>await HttpRequest.getString(path)</code> 就表示必须要等到 <code>HttpRequest.getString(path)</code> 返回的 <code>Future</code> 有了最终结果才会继续往下执行 <code>_parsePirateNamesFromJSON(jsonString);</code>。</p>
<hr>
<p>不知道 Dart 支不支持一些高大上的语言特性，比如 闭包（Closure）、Lambda表达式（Lambda expression）、生成器（Generator）等，期待后续的学习。</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>





  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2014-10-18T16:00:00.000Z"><a href="/2014/10/19/byte-code-on-try-catch/">2014-10-19</a></time>
      
      
  
    <h1 class="title"><a href="/2014/10/19/byte-code-on-try-catch/">用 bytecode 来看 try-catch-finally 和 return</a></h1>
  

    </header>
    <div class="entry">
      
        <p>最近一直在看Java虚拟机规范，发现直接分析bytecode更能加深对Java语言的理解。<br>之前看过一篇关于 <code>return</code> 和 <code>finally</code> 执行顺序的文章，仅在 Java 的语言层面做了分析，其实我倒觉得直接看 bytecode 可能来的更清晰一点。</p>
<p>先看一个只有 <code>try-finally</code>，没有 <code>catch</code> 的例子。</p>
<p><strong>try - finally</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExceptionTest</span> </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">tryFinally</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      tryItOut();</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">      wrapItUp();</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line"></div><div class="line">  <span class="comment">// auxiliary methods</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">tryItOut</span><span class="params">()</span> </span>&#123; &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">wrapItUp</span><span class="params">()</span> </span>&#123;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过 <code>javap -c ExceptionTest</code> 来查看它的字节码。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">public void tryFinally();</div><div class="line">  Code:</div><div class="line">     0: aload_0</div><div class="line">     1: invokevirtual #2  // Method tryItOut:()V</div><div class="line">     4: aload_0</div><div class="line">     5: invokevirtual #3  // Method wrapItUp:()V</div><div class="line">     8: goto          18</div><div class="line">    11: astore_1</div><div class="line">    12: aload_0</div><div class="line">    13: invokevirtual #3  // Method wrapItUp:()V</div><div class="line">    16: aload_1</div><div class="line">    17: athrow</div><div class="line">    18: return</div><div class="line">  Exception table:</div><div class="line">     from    to  target type</div><div class="line">         0     4    11   any</div></pre></td></tr></table></figure>
<p>如果没有抛出异常，那么它的执行顺序为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">0: aload_0</div><div class="line">1: invokevirtual #2  // Method tryItOut:()V</div><div class="line">4: aload_0</div><div class="line">5: invokevirtual #3  // Method wrapItUp:()V</div><div class="line">18: return</div></pre></td></tr></table></figure>
<p>如果抛出了异常，JVM 会在</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Exception table:</div><div class="line">   from    to  target type</div><div class="line">       0     4    11   any</div></pre></td></tr></table></figure>
<p>中进行控制跳转。如果是位于0到4字节之间的命令抛出了任何类型（any type）的异常，会跳转到11字节处继续运行。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">11: astore_1</div><div class="line">12: aload_0</div><div class="line">13: invokevirtual #3</div><div class="line">16: aload_1</div><div class="line">17: athrow</div></pre></td></tr></table></figure>
<p>astore_1会把抛出的异常对象保存到local variable数组的第二个元素。下面两行指令用来调用成员方法wrapItUp。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">12: aload_0</div><div class="line">13: invokevirtual #3</div></pre></td></tr></table></figure>
<p>最后通过</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">16: aload_1</div><div class="line">17: athrow</div></pre></td></tr></table></figure>
<p>重新抛出异常。</p>
<p>通过以上分析可以得出结论：</p>
<blockquote>
<p>在try-finally中，try块中抛出的异常会首先保存在local variable中，然后执行finally块，执行完毕后重新抛出异常。</p>
</blockquote>
<p>如果我们把代码修改一下，在try块中直接return。</p>
<p><strong>try - return - finally</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">tryFinally</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">    tryItOut();</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">  &#125; <span class="keyword">finally</span> &#123;</div><div class="line">    wrapItUp();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>”反汇编“一下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"> 0: aload_0</div><div class="line"> 1: invokevirtual #2 // Method tryItOut:()V</div><div class="line"> 4: aload_0</div><div class="line"> 5: invokevirtual #3 // Method wrapItUp:()V</div><div class="line"> 8: return</div><div class="line"> 9: astore_1</div><div class="line">10: aload_0</div><div class="line">11: invokevirtual #3 // Method wrapItUp:()V</div><div class="line">14: aload_1</div><div class="line">15: athrow</div></pre></td></tr></table></figure>
<p>可以看出finally块的代码仍然被放到了return之前。</p>
<blockquote>
<p>如果try块中有return statement，一定是finally中的代码先执行，然后return。</p>
</blockquote>
<p>JVM规范是这么说的：</p>
<blockquote>
<p>Compilation of a try-finally statement is similar to that of try-catch. Pior to transferring control outside thetry statement, whether that transfer is normal or abrupt, because an exception has been thrown, thefinally clause must first be execute.<br>try - catch - finally</p>
</blockquote>
<p>给上面的代码加一个catch块</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">tryCatchFinally</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">    tryItOut();</div><div class="line">  &#125; <span class="keyword">catch</span> (TestExc e) &#123;</div><div class="line">    handleExc(e);</div><div class="line">  &#125; <span class="keyword">finally</span> &#123;</div><div class="line">    wrapItUp();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>javap一下</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">public void tryCatchFinally();</div><div class="line">  Code:</div><div class="line">     0: aload_0</div><div class="line">     1: invokevirtual #2</div><div class="line">     4: aload_0</div><div class="line">     5: invokevirtual #3</div><div class="line">     8: goto          31</div><div class="line">    11: astore_1</div><div class="line">    12: aload_0</div><div class="line">    13: aload_1</div><div class="line">    14: invokevirtual #5                  </div><div class="line">    17: aload_0</div><div class="line">    18: invokevirtual #3</div><div class="line">    21: goto          31</div><div class="line">    24: astore_2</div><div class="line">    25: aload_0</div><div class="line">    26: invokevirtual #3</div><div class="line">    29: aload_2</div><div class="line">    30: athrow</div><div class="line">    31: return</div><div class="line">Exception table:</div><div class="line">   from    to  target type</div><div class="line">       0     4    11   Class TestExc</div><div class="line">       0     4    24   any</div><div class="line">      11    17    24   any</div></pre></td></tr></table></figure>
<p>通过Exception table可以看出：</p>
<ul>
<li>catch监听 0 ~ 4 字节类型为TextExc的异常。</li>
<li>finally为 0 ~ 4 以及 11 ~ 17 字节任何类型的异常。</li>
</ul>
<p>也就说 catch block 本身也在 finally block 的管辖范围之内。如果catch block 中有 return statement，那么也一定是在 finally block 之后执行。</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>






<nav id="pagination">
  
    <a href="/page/6/" class="alignleft prev">上一页</a>
  
  
    <a href="/page/8/" class="alignright next">下一页</a>
  
  <div class="clearfix"></div>
</nav></div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="搜索">
    <input type="hidden" name="q" value="site:liangfei.me">
  </form>
</div>

  

  
<div class="widget tagcloud">
  <h3 class="title">标签云</h3>
  <div class="entry">
    <a href="/tags/Android/" style="font-size: 20px;">Android</a> <a href="/tags/Git/" style="font-size: 12px;">Git</a> <a href="/tags/Hybrid/" style="font-size: 12px;">Hybrid</a> <a href="/tags/Japanese/" style="font-size: 14px;">Japanese</a> <a href="/tags/Java/" style="font-size: 16px;">Java</a> <a href="/tags/Retrofit/" style="font-size: 12px;">Retrofit</a> <a href="/tags/RxJava/" style="font-size: 10px;">RxJava</a> <a href="/tags/Web/" style="font-size: 12px;">Web</a> <a href="/tags/iOS/" style="font-size: 10px;">iOS</a> <a href="/tags/个人/" style="font-size: 10px;">个人</a> <a href="/tags/工具/" style="font-size: 10px;">工具</a> <a href="/tags/生活/" style="font-size: 18px;">生活</a> <a href="/tags/移动开发/" style="font-size: 10px;">移动开发</a> <a href="/tags/车/" style="font-size: 10px;">车</a>
  </div>
</div>


  
<div class="widget tag">
  <h3 class="title">最新文章</h3>
  <ul class="entry">
    
      <li>
        <a href="/2017/03/21/app-force-update-architecture/">Android 强升逻辑和实现</a>
      </li>
    
      <li>
        <a href="/2017/02/15/2016-summary/">2016 年终总结</a>
      </li>
    
      <li>
        <a href="/2017/02/04/thinking-in-mobile/">关于 App 开发的一些思考</a>
      </li>
    
      <li>
        <a href="/2017/02/01/note-on-web-data-analysis/">架构笔记之数据分析</a>
      </li>
    
      <li>
        <a href="/2017/02/01/note-on-web-security/">架构笔记之安全</a>
      </li>
    
  </ul>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2017 liangfei
  
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>


<script type="text/javascript">
var disqus_shortname = 'liangfeizc';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>