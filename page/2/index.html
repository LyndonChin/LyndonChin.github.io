<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>第 2 页 | 梁飞</title>
  <meta name="author" content="liangfei">
  
  <meta name="description" content="梁飞的个人博客">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="梁飞"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="梁飞" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  

</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">梁飞</a></h1>
  <h2><a href="/">行有不得反求诸己</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
      <li><a href="/about">About</a></li>
    
    <li><a href="https://github.com/lyndonchin">Github</a></li>
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper">
  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2017-02-01T14:56:00.000Z"><a href="/2017/02/01/note-on-web-data-analysis/">2017-02-01</a></time>
      
      
  
    <h1 class="title"><a href="/2017/02/01/note-on-web-data-analysis/">架构笔记之数据分析</a></h1>
  

    </header>
    <div class="entry">
      
        <p><a href="http://www.jianshu.com/p/8f46735b2bdd" target="_blank" rel="external">http://www.jianshu.com/p/8f46735b2bdd</a></p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>





  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2017-02-01T01:39:00.000Z"><a href="/2017/02/01/note-on-web-security/">2017-02-01</a></time>
      
      
  
    <h1 class="title"><a href="/2017/02/01/note-on-web-security/">架构笔记之安全</a></h1>
  

    </header>
    <div class="entry">
      
        <p><a href="http://www.jianshu.com/p/f2aa311df010" target="_blank" rel="external">http://www.jianshu.com/p/f2aa311df010</a></p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>





  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2016-09-14T09:40:06.000Z"><a href="/2016/09/14/how-to-write-custom-gradle-plugin/">2016-09-14</a></time>
      
      
  
    <h1 class="title"><a href="/2016/09/14/how-to-write-custom-gradle-plugin/">写 Gradle 插件的一点经验</a></h1>
  

    </header>
    <div class="entry">
      
        <p>本着简单易用的原则，参考<a href="https://github.com/KeepSafe/android-resource-remover" target="_blank" rel="external">android-resource-remover</a> 写了一个删除无用资源文件的 Gradle 插件 - <a href="https://github.com/YouzanMobile/clean-unused-resources-gradle-plugin" target="_blank" rel="external">clean-unused-resources-gradle-plugin</a>，结果微博发出来不到10分钟，<a href="http://weibo.com/u/2491729875?topnav=1&amp;wvr=6&amp;topsug=1&amp;is_all=1" target="_blank" rel="external">陈启超</a>就告诉我 AS2.0+ 已经提供了<a href="http://stackoverflow.com/questions/6373482/remove-all-unused-resources-from-an-android-project" target="_blank" rel="external">此功能</a>。天哪，为了纪念这个短命无用的轮子，我只好写篇博客，把造轮子的过程记录下来，也算对别人有点用处。</p>
<p><a href="https://docs.gradle.org/current/userguide/custom_plugins.html" target="_blank" rel="external">官方文档</a>说了，自定义 Gradle 插件有三种方式：</p>
<ol>
<li>Build script</li>
<li><code>buildSrc</code> project</li>
<li>Standalone project</li>
</ol>
<p>但是，AS 不完美支持第三种方式，我们用 AS 的爸爸 <a href="https://www.google.co.jp/url?sa=t&amp;rct=j&amp;q=&amp;esrc=s&amp;source=web&amp;cd=1&amp;cad=rja&amp;uact=8&amp;ved=0ahUKEwiD0qrLho7PAhVO4GMKHYqWDd4QFggeMAA&amp;url=https%3A%2F%2Fwww.jetbrains.com%2Fidea%2Fdownload%2F&amp;usg=AFQjCNFTvvWm6f-CgwkzJvE5OINbz0s-Mg" target="_blank" rel="external">IntelliJ IDEA CE</a> 就好了。</p>
<p>首先 New 一个基于 Gradle 的 Groovy 工程：</p>
<p><img src="http://upload-images.jianshu.io/upload_images/620698-b0fe160f1a0de293.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="new a groovy project"></p>
<p>修改一下自动生成的 build.gradle 文件，把 <code>repositories</code> 和 <code>dependencies</code> 替换掉，其他保持不变。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">repositories &#123;</div><div class="line">  jcenter()</div><div class="line">&#125;</div><div class="line"></div><div class="line">dependencies &#123;</div><div class="line">  compile gradleApi()</div><div class="line">  testCompile <span class="string">group:</span> <span class="string">'junit'</span>, <span class="string">name:</span> <span class="string">'junit'</span>, <span class="string">version:</span> <span class="string">'4.11'</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后创建 <code>src</code> 和 <code>resources</code> 目录（以 <a href="https://github.com/YouzanMobile/clean-unused-resources-gradle-plugin" target="_blank" rel="external">clean-unused-resources-gradle-plugin</a> 为例）：</p>
<p><img src="http://upload-images.jianshu.io/upload_images/620698-1d195dc7d9796835.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="project structure"></p>
<p><code>resources/META-INF/gradle-plusings/</code> 是必不可少，否则别人无法使用你的插件，目录下的 <code>*.properties</code> 文件名就是插件的名字，别人<code>apply</code> 的时候会用到：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">apply <span class="string">plugin:</span> <span class="string">'com.youzan.mobile.cleaner'</span></div></pre></td></tr></table></figure>
<p>文件内容是把  <code>implementation-class</code> 指向你插件类的全名。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">implementation-class=com.youzan.mobile.CleanerPlugin</div></pre></td></tr></table></figure>
<p><code>CleanerPlugin.groovy</code> 实现了接口<code>Plugin&lt;Project&gt;</code>，而 <code>org.gradle.api.Plugin</code> 就是由 <code>compile gradleApi()</code> 提供，我们在 build.gradle 的 <code>dependencies</code> 中已经添加过了。</p>
<p>准备就绪，开始写插件。</p>
<p>首先，实现 <code>apply</code> 方法：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">CleanerPlugin</span> <span class="keyword">implements</span> <span class="title">Plugin</span>&lt;<span class="title">Project</span>&gt; &#123;</span></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="keyword">void</span> apply(Project project) &#123;</div><div class="line">    <span class="comment">// 创建一个 extension</span></div><div class="line">    project.extensions.create(<span class="string">'resourceCleaner'</span>, CleanerExtension);</div><div class="line">    <span class="comment">// 修改 lint report 路径</span></div><div class="line">    project.afterEvaluate &#123;</div><div class="line">      project.android.lintOptions.xmlOutput = <span class="keyword">new</span> File(project.buildDir, <span class="string">"lintResult.xml"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 创建 task</span></div><div class="line">    project.tasks.create(<span class="string">'cleanResource'</span>, CleanTask)</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>第一步通过 <code>project.extensions.create</code> 创建一个 <code>extension</code>：</p>
<p><em>CleanerExtension.groovy</em><br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">CleanerExtension</span> &#123;</span></div><div class="line">  Iterable&lt;String&gt; excludedFiles</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这个 <code>extension</code> 用于别人向你的插件传递参数，例如：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">resourceCleaner &#123;</div><div class="line">  excludedFiles = [</div><div class="line">    <span class="string">'string_pos.xml'</span>,</div><div class="line">    <span class="string">'string_car.xml'</span>,</div><div class="line">  ]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>第二步修改 lint report 的路径：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">project.afterEvaluate &#123;</div><div class="line">  project.android.lintOptions.xmlOutput = <span class="keyword">new</span> File(project.buildDir, <span class="string">"lintResult.xml"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里用到了 Android Gradle Plugin 的 DSL，所以 IDEA 无法动态提示，没关系，我们直接去翻<a href="http://google.github.io/android-gradle-dsl/current/" target="_blank" rel="external">文档</a>，里面有详解的解释：</p>
<p><img src="http://upload-images.jianshu.io/upload_images/620698-eabe9b5c18386134.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Android Plugin DSL References"></p>
<p>配置参数（CleanerExtension）和文件参数（lintOptions.xmlOutput）都准备好了。</p>
<p>第三步，主角上场，创建一个 <code>task</code>：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">CleanTask</span> <span class="keyword">extends</span> <span class="title">DefaultTask</span> &#123;</span></div><div class="line">  CleanTask() &#123;</div><div class="line">    <span class="keyword">super</span>()</div><div class="line">    dependsOn <span class="string">"lint"</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@TaskAction</span></div><div class="line">  <span class="keyword">def</span> clean() &#123;</div><div class="line">    <span class="keyword">def</span> lintResult = project.android.lintOptions.xmlOutput</div><div class="line">    <span class="keyword">def</span> excludedFiles = project.resourceCleaner.excludedFiles</div><div class="line">    Cleaner.clean(lintResult, excludedFiles)</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>CleanTask</code> 继承自 <code>DefaultTask</code>，因为 CleanTask 的输入是 lint report，所以在构造方法中通过调用 <code>dependsOn &quot;lint&quot;</code> 让自己依赖于 lint 这个 <code>task</code>。</p>
<p><code>CleanTask</code> 就好像 1984 里面的猪，只负责发号施令，安排工作，真正干活的“人”是 <code>Cleaner</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cleaner</span> </span>&#123;</div><div class="line">    <span class="function">def <span class="keyword">static</span> <span class="title">clean</span><span class="params">(File report, Iterable&lt;String&gt; excludedFiles)</span> </span>&#123;</div><div class="line">        def issues = <span class="keyword">new</span> XmlSlurper().parse(report)</div><div class="line">        issues.<span class="string">'*'</span>.findAll &#123;</div><div class="line">            it.name() == <span class="string">'issue'</span> &amp;&amp; it.<span class="meta">@id</span> == <span class="string">'UnusedResources'</span></div><div class="line">        &#125;.each &#123;</div><div class="line">            def file = <span class="keyword">new</span> File(it.location.<span class="meta">@file</span>.text())</div><div class="line">            <span class="keyword">if</span> (file.name in excludedFiles) <span class="keyword">return</span>;</div><div class="line">            def line = it.location.<span class="meta">@line</span></div><div class="line">            def column = it.location.<span class="meta">@column</span></div><div class="line"></div><div class="line">            <span class="keyword">if</span> ((line == <span class="string">''</span> &amp;&amp; column == <span class="string">''</span>) || column == <span class="string">'1'</span>) &#123;</div><div class="line">                println <span class="string">"deleting "</span> + file.path</div><div class="line">                file.delete()</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                def m = it.<span class="meta">@message</span> =~ $/`R.(\w+).([^`]+)`/$</div><div class="line">                <span class="keyword">if</span> (!m) <span class="keyword">return</span>;</div><div class="line"></div><div class="line">                def type = m.group(<span class="number">1</span>)</div><div class="line">                def entryName = m.group(<span class="number">2</span>);</div><div class="line"></div><div class="line">                def parsed = <span class="keyword">new</span> XmlSlurper().parse(file)</div><div class="line">                parsed.<span class="string">'**'</span>.findAll &#123;</div><div class="line">                    it.<span class="meta">@name</span> == entryName &amp;&amp; it.name().contains(type)</div><div class="line">                &#125;*.replaceNode &#123;&#125;</div><div class="line"></div><div class="line">                XmlUtil.serialize(parsed, <span class="keyword">new</span> FileWriter(file))</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>一个简单的独立工程的 Gradle Plugin 就这么写完了，是不是非常简单，先不要高兴，还有最后一步 - 发布到 jCenter。</p>
<p>继续修改 <code>build.gralde</code>。</p>
<p>添加 bintray 插件。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">plugins &#123;</div><div class="line">    id <span class="string">"com.jfrog.bintray"</span> version <span class="string">"1.4"</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">Properties properties = <span class="keyword">new</span> Properties();</div><div class="line">properties.load(project.rootProject.file(<span class="string">'local.properties'</span>).newDataInputStream())</div><div class="line"></div><div class="line">bintray &#123;</div><div class="line">    user = properties.getProperty(<span class="string">"bintray.user"</span>)</div><div class="line">    key = properties.getProperty(<span class="string">"bintray.apikey"</span>)</div><div class="line">    publications = [<span class="string">'mavenJava'</span>]</div><div class="line">    pkg &#123;</div><div class="line">        repo = <span class="string">'maven'</span></div><div class="line">        name = <span class="string">'cleaner-gradle-plugin'</span></div><div class="line">        desc = <span class="string">'a gradle plugin to clean unused resources detected by Lint'</span></div><div class="line">        websiteUrl = <span class="string">'https://github.com/YouzanMobile/clean-resource-gradle-plugin'</span></div><div class="line">        issueTrackerUrl = <span class="string">'https://github.com/YouzanMobile/clean-resource-gradle-plugin/issues'</span></div><div class="line">        vcsUrl =<span class="string">'https://github.com/YouzanMobile/clean-resource-gradle-plugin'</span></div><div class="line">        publicDownloadNumbers = <span class="literal">true</span></div><div class="line">        licenses = [<span class="string">'MIT'</span>]</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>maven-publish 插件：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">apply <span class="string">plugin:</span> <span class="string">'maven-publish'</span></div><div class="line"></div><div class="line"><span class="comment">// custom tasks for creating source/javadoc jars</span></div><div class="line">task sourcesJar(<span class="string">type:</span> Jar, <span class="string">dependsOn:</span> classes) &#123;</div><div class="line">    classifier = <span class="string">'sources'</span></div><div class="line">    from sourceSets.main.allSource</div><div class="line">&#125;</div><div class="line"></div><div class="line">task javadocJar(<span class="string">type:</span> Jar, <span class="string">dependsOn:</span> javadoc) &#123;</div><div class="line">    classifier = <span class="string">'javadoc'</span></div><div class="line">    from javadoc.destinationDir</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// add javadoc/source jar tasks as artifacts</span></div><div class="line">artifacts &#123;</div><div class="line">    archives sourcesJar, javadocJar</div><div class="line">&#125;</div><div class="line"></div><div class="line">publishing &#123;</div><div class="line">    publications &#123;</div><div class="line">        mavenJava(MavenPublication) &#123;</div><div class="line">            from components.java</div><div class="line">            artifact sourcesJar</div><div class="line">            artifact javadocJar</div><div class="line">            groupId <span class="string">'com.youzan.mobile'</span></div><div class="line">            artifactId <span class="string">'cleaner-gradle-plugin'</span></div><div class="line">            version versionName</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>OK，大功告成，演出结束，下面是致谢：</p>
<ul>
<li><a href="https://github.com/jasonross/NuwaGradle" target="_blank" rel="external">NuwaGradle</a></li>
<li><a href="http://weibo.com/chenqichao2016" target="_blank" rel="external">陈启超_V</a></li>
<li><a href="https://docs.gradle.org/current/userguide/userguide.html" target="_blank" rel="external">Gradle User Guide</a></li>
</ul>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>





  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2016-07-28T14:40:00.000Z"><a href="/2016/07/28/work-summary-after-half-year-leaving/">2016-07-28</a></time>
      
      
  
    <h1 class="title"><a href="/2016/07/28/work-summary-after-half-year-leaving/">有赞入职半年总结</a></h1>
  

    </header>
    <div class="entry">
      
        <p>今年 1.11 入职有赞，到现在差不多 7 个多月。</p>
<h2 id="一点微小的工作"><a href="#一点微小的工作" class="headerlink" title="一点微小的工作"></a>一点微小的工作</h2><hr>
<h3 id="统一-Maven-仓库"><a href="#统一-Maven-仓库" class="headerlink" title="统一 Maven 仓库"></a>统一 Maven 仓库</h3><p>旧的二方包部署方式非常不专业，统一打包脚本之后，使协作变得高效。</p>
<ul>
<li>所有二方包全部部署到公司内部 Maven 仓库，删掉所有跟随源码的私有仓库，节约 git 服务器空间。</li>
<li>把源码、注释、文档全部打进二方包，方便接入方查看源码。</li>
<li>坚持代码为中心，文档（README、WIKI）跟着代码走。</li>
</ul>
<blockquote>
<p>这是我在有赞做的第一件事</p>
</blockquote>
<hr>
<h3 id="统一-WebView-框架"><a href="#统一-WebView-框架" class="headerlink" title="统一 WebView 框架"></a>统一 WebView 框架</h3><p>重构旧的 WebView 框架，重构之后的优势：</p>
<ol>
<li>只有 4.2 以下版本使用注入 js 的方式实现 hybrid api，&gt;= 4.2 的版本使用 <code>@javascriptinterface</code>，大大降低了旧方式注入失败的概率。</li>
<li>每个 hybrid api 相互独立，独自定义 Model 类。（旧方式是共享一个 Model，导致 Model 无比臃肿）。</li>
<li>注入、回调的接口更加合理。</li>
<li>同时支持新旧协议。</li>
<li>接入 Web Cache。</li>
</ol>
<hr>
<h3 id="引入-RxJava-Retrofit"><a href="#引入-RxJava-Retrofit" class="headerlink" title="引入 RxJava + Retrofit"></a>引入 RxJava + Retrofit</h3><p>替换旧的网络框架，在<strong>有赞商家版</strong>中接入 Retrofit &amp; RxJava。</p>
<ul>
<li>输出一篇 <a href="http://www.liangfei.me/2016/07/06/my-practice-with-retrofit-and-rxjava/" target="_blank" rel="external">Retrofit + RxAndroid 实践总结</a>。</li>
<li>读完了 Retrofit 源码，输出一篇 <a href="http://www.liangfei.me/2016/07/10/diagram-retrofit-service-method/" target="_blank" rel="external">图解 Retrofit 之 ServiceMethod</a>。</li>
</ul>
<hr>
<h3 id="排查-Memory-Leaks"><a href="#排查-Memory-Leaks" class="headerlink" title="排查 Memory Leaks"></a>排查 Memory Leaks</h3><ul>
<li>接入 <code>LeakCanary</code>，居然有 static 的 view 变量。ありえない！</li>
<li>读完了源码 - <a href="https://github.com/LyndonChin/wo/tree/master/leakcanary" target="_blank" rel="external">LeakCanary 原理分析</a>。</li>
</ul>
<hr>
<h3 id="开发数据图表库"><a href="#开发数据图表库" class="headerlink" title="开发数据图表库"></a>开发数据图表库</h3><ul>
<li>基于 <a href="https://github.com/PhilJay/MPAndroidChart" target="_blank" rel="external">MPAndroidChart</a> 二次开发，加了一些特殊交互。</li>
<li>花了三周时间彻底搞懂了源码 - <a href="https://github.com/LyndonChin/wo/tree/master/mpandroicharts" target="_blank" rel="external">MPAndroidCharts 源码解析</a>。</li>
</ul>
<blockquote>
<p>MPAndroidCharts 的代码质量跟 star 数完全不匹配</p>
</blockquote>
<hr>
<h3 id="使用-product-flavor-适配-pos-机"><a href="#使用-product-flavor-适配-pos-机" class="headerlink" title="使用 product flavor 适配 pos 机"></a>使用 product flavor 适配 pos 机</h3><ul>
<li>POS 机特有代码互不干扰。</li>
<li>减小包大小。</li>
</ul>
<blockquote>
<p>只用了一个晚上</p>
</blockquote>
<hr>
<h3 id="读了很多内部源码"><a href="#读了很多内部源码" class="headerlink" title="读了很多内部源码"></a>读了很多内部源码</h3><ul>
<li>商家版 APP 源码</li>
<li>基于 okhttp 的网络库</li>
<li>23 版本后的权限适配库</li>
<li>基于 AndFix 的热修复库</li>
<li>一些 UI 库</li>
</ul>
<hr>
<h3 id="做了一些技术分享"><a href="#做了一些技术分享" class="headerlink" title="做了一些技术分享"></a>做了一些技术分享</h3><ol>
<li>RxJava 入门</li>
<li>GOOGLE/IO 2016</li>
<li>30分钟精通 Retrofit</li>
</ol>
<hr>
<p>生活变得更加有序，心态要平和。</p>
<blockquote>
<p>性格を優しくしないと！</p>
</blockquote>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>





  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2016-07-20T13:33:33.000Z"><a href="/2016/07/20/the-weird-NoClassDefFoundError/">2016-07-20</a></time>
      
      
  
    <h1 class="title"><a href="/2016/07/20/the-weird-NoClassDefFoundError/">诡异的问题 NoClassDefFoundError</a></h1>
  

    </header>
    <div class="entry">
      
        <p>今天又遇到一个比较难搞的问题，记一下流水账。</p>
<p>APP 中引用了一个二方包，编译成功，结果运行时报错 - <code>NoClassDefFoundError</code>。</p>
<h2 id="try-1-multiDexKeepProguard"><a href="#try-1-multiDexKeepProguard" class="headerlink" title="try #1 - multiDexKeepProguard"></a>try #1 - multiDexKeepProguard</h2><p>首先确认是不是由于类没有被放到 main dex 中导致了这个问题。打开文件 <code>build/intermediates/multi-dex/debug/maindexlist.txt</code>，查找类名，发现文件中包含了我们要找的类。</p>
<p>不放心，说不定是 Multidex 的bug，手动把这个“丢失”的类放进 main dex。</p>
<p><em>build.gralde</em><br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">android &#123;</div><div class="line">  defaultConfig &#123;</div><div class="line">    multiDexEnabled = <span class="literal">true</span></div><div class="line">    multiDexKeepProguard file(<span class="string">'multidex.pro'</span>)</div><div class="line">  &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><em>multidex.pro</em><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">-keep public the-full-name-of-the-missing-class &#123; *; &#125;</div></pre></td></tr></table></figure></p>
<p>编译运行，问题依然，并没有什么卵用。</p>
<p>既然不是 main dex 问题，那我们先来确认一下问题是否由 MultiDex 引起。</p>
<h2 id="try-2-关掉-Multidex"><a href="#try-2-关掉-Multidex" class="headerlink" title="try #2 - 关掉 Multidex"></a>try #2 - 关掉 Multidex</h2><p>关掉 multidex 然后打一个 release 包。</p>
<blockquote>
<p>由于方法数受限，关掉 Multidex 之后打不出 Debug 包，但是混淆过后方法数减少很多，可以顺利打出 Release 包。</p>
</blockquote>
<p><em>build.gradle</em><br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">defaultConfig &#123;</div><div class="line">  multiDexEnabled <span class="literal">true</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>编译运行，依然出错，可以确定不是 Multidex 的锅。</p>
<h2 id="try-3-传递依赖"><a href="#try-3-传递依赖" class="headerlink" title="try #3 - 传递依赖"></a>try #3 - 传递依赖</h2><p>把依赖由只依赖 aar 改为传递依赖。</p>
<p><del><code>compile &#39;me.liangfei.android:weird-1.0.0@aar&#39;</code></del><br><code>compile &#39;me.liangfei.android:weird-1.0.0&#39;</code></p>
<p>结果却发现 <code>weird.aar</code> 引用了一个<strong>服务端已经删除但是有本地缓存</strong>的包，也就是说 <code>weird.aar</code> 引用了一个并不存在的包，所以改为传递依赖之后，gradle 无法获取这个并不存在的包。</p>
<p>由此推断出，<code>weird.aar</code> 肯定不是一个“正确”的包，估计上面的问题也是由此引发（待确认）。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><h3 id="打包"><a href="#打包" class="headerlink" title="打包"></a>打包</h3><ul>
<li>本地打包不可信</li>
<li>必须要通过 CI 发包</li>
</ul>
<h3 id="ClassNotFoundException-vs-NoClassDefFoundError"><a href="#ClassNotFoundException-vs-NoClassDefFoundError" class="headerlink" title="ClassNotFoundException vs NoClassDefFoundError"></a>ClassNotFoundException vs NoClassDefFoundError</h3><ul>
<li><code>ClassNotFoundException</code> 一般是 <code>ClassLoader</code> 无法找到类导致的，例如 <code>Class.forName(&quot;your-class&quot;)</code>。</li>
<li><code>NoClassDefFoundError</code> 一般是属于 <strong>Link Error</strong>，主要是由于打包之后缺失文件导致的，例如 <code>new</code> 一个对象。</li>
</ul>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>






<nav id="pagination">
  
    <a href="/" class="alignleft prev">上一页</a>
  
  
    <a href="/page/3/" class="alignright next">下一页</a>
  
  <div class="clearfix"></div>
</nav></div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="搜索">
    <input type="hidden" name="q" value="site:liangfei.me">
  </form>
</div>

  

  
<div class="widget tagcloud">
  <h3 class="title">标签云</h3>
  <div class="entry">
    <a href="/tags/Android/" style="font-size: 20px;">Android</a> <a href="/tags/Git/" style="font-size: 12.5px;">Git</a> <a href="/tags/Gradle/" style="font-size: 10px;">Gradle</a> <a href="/tags/Hybrid/" style="font-size: 10px;">Hybrid</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/Retrofit/" style="font-size: 12.5px;">Retrofit</a> <a href="/tags/RxJava/" style="font-size: 10px;">RxJava</a> <a href="/tags/Web/" style="font-size: 12.5px;">Web</a> <a href="/tags/dart/" style="font-size: 10px;">dart</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/iOS/" style="font-size: 10px;">iOS</a> <a href="/tags/个人总结/" style="font-size: 17.5px;">个人总结</a> <a href="/tags/产品设计/" style="font-size: 10px;">产品设计</a> <a href="/tags/单元测试/" style="font-size: 10px;">单元测试</a> <a href="/tags/汽车/" style="font-size: 10px;">汽车</a> <a href="/tags/测试/" style="font-size: 10px;">测试</a> <a href="/tags/移动开发/" style="font-size: 10px;">移动开发</a>
  </div>
</div>


  
<div class="widget tag">
  <h3 class="title">最新文章</h3>
  <ul class="entry">
    
      <li>
        <a href="/2017/07/06/improve-quanlity-with-mockito/">Mockito 用法和原理</a>
      </li>
    
      <li>
        <a href="/2017/07/04/2017-semi-annual-summary/">2017 年中总结</a>
      </li>
    
      <li>
        <a href="/2017/03/21/app-force-update-architecture/">Android 强升逻辑和实现</a>
      </li>
    
      <li>
        <a href="/2017/02/15/2016-summary/">2016 年终总结</a>
      </li>
    
      <li>
        <a href="/2017/02/04/thinking-in-mobile/">关于 App 开发的一些思考</a>
      </li>
    
  </ul>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2017 liangfei
  
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>


<script type="text/javascript">
var disqus_shortname = 'liangfeizc';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>