<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
          Retrofit + RxAndroid 实践总结 - 梁飞的博客 | liangfei&#39;s Blog
        
    </title>

    <link rel="canonical" href="http://liangfei.me/2016/07/06/android-retrofit-and-rxjava/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/hux-blog.min.css">

    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="/css/highlight.css">

    <!-- Custom Fonts -->
    <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">LIANG.FEI</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>

                    

                        
                    

                        
                        <li>
                            <a href="/about/">About</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/archives/">Archives</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/tags/">Tags</a>
                        </li>
                        
                    
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Main Content -->
    
<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        background-image: url('/img/home-bg.jpg')
    }
</style>
<header class="intro-header" >
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                          <a class="tag" href="/tags/#Android" title="Android">Android</a>
                        
                          <a class="tag" href="/tags/#Retrofit" title="Retrofit">Retrofit</a>
                        
                          <a class="tag" href="/tags/#RxJava" title="RxJava">RxJava</a>
                        
                    </div>
                    <h1>Retrofit + RxAndroid 实践总结</h1>
                    <h2 class="subheading"></h2>
                    <span class="meta">
                        Posted by liangfei on
                        2016-07-06
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <p>在接入 Retrofit + RxAndroid 之前，项目代码中主要存在如下问题：</p>
<ol>
<li>服务器 API 的定义方式不一致，有的集中定义，有的定义在业务代码中，没有分类不便于维护。</li>
<li>Request / Response / API 三者没有对应关系（Request 参数使用 Map 传递，Response 返回 JSON 数据）。</li>
<li>每次都需要传递 <code>access_token</code> 给需要验证登录的 API。</li>
<li>Response 中错误信息的数据结构不一致，错误处理不统一。</li>
</ol>
<p>引入 Retrofit + RxAndroid 后，以上问题都会迎刃而解。</p>
<a id="more"></a>
<h2 id="定义基类"><a href="#定义基类" class="headerlink" title="定义基类"></a>定义基类</h2><p>首先定义一个 <code>BaseResponse</code>，所有的 Response 都要继承自它。</p>
<h3 id="Response"><a href="#Response" class="headerlink" title="Response"></a>Response</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Keep</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseResponse</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CODE_SUCCESS = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String msg;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> code;</span><br><span class="line">    <span class="meta">@SerializedName</span>(<span class="string">"error_response"</span>)</span><br><span class="line">    <span class="keyword">public</span> ErrorResponse errorResponse;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ErrorResponse</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> String msg;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> code;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>BaseResponse</code> 的主要作用是统一了错误信息的格式，同时为后面统一错误处理打好基础。</p>
<h3 id="ErrorResponseException"><a href="#ErrorResponseException" class="headerlink" title="ErrorResponseException"></a>ErrorResponseException</h3><p>为了统一<strong>请求错误</strong>和<strong>返回错误</strong>，我们定义了一个继承自 <code>IOException</code> 的子类 <code>ErrorResponseException</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ErrorResponseException</span> <span class="keyword">extends</span> <span class="title">IOException</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ErrorResponseException</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ErrorResponseException</span><span class="params">(String detailMessage)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(detailMessage);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="定义-Service-Method"><a href="#定义-Service-Method" class="headerlink" title="定义 Service Method"></a>定义 Service Method</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TradeService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@GET</span>(<span class="string">"api.tradecategories/1.0.0/get"</span>)</span><br><span class="line">    Observable&lt;Response&lt;CategoryResponse&gt;&gt; tradeCategories();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GET</span>(<span class="string">"api.trade/1.0.0/get"</span>)</span><br><span class="line">    Observable&lt;Response&lt;TradeItemResponse&gt;&gt; tradeDetail(<span class="meta">@Query</span>(<span class="string">"tid"</span>) String tid);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中 <code>CategoryResponse</code>、<code>TradeItemResponse</code> 全部继承自 <code>BaseResponse</code>。</p>
<p>泛型 <code>Response</code> 由 Retrofit 提供，定义了三个成员变量：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> okhttp3.Response rawResponse;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> T body;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ResponseBody errorBody;</span><br></pre></td></tr></table></figure>
<p>可以看出，<code>Response</code> 是对 <code>okhttp3.Response</code> 的封装，<code>body</code> 是一个 <code>BaseResponse</code> 实例。</p>
<p>因为 <code>Response</code> 只会根据 <code>code</code> 值判断请求是否成功，而不会判断 <code>body</code> 的内容是否出错，所以我们把 <code>Response</code> 中的错误信息称作<strong>请求错误</strong>，把 <code>body</code> 中的错误信息称作<strong>返回错误</strong>。</p>
<p>既然 <code>Response</code> 包含了 <code>BaseResponse</code>（即 <code>body</code>），那么我们就可以对两种错误（请求错误、返回错误）进行统一处理。</p>
<h2 id="统一错误处理"><a href="#统一错误处理" class="headerlink" title="统一错误处理"></a>统一错误处理</h2><p>Service Method 的返回值类型是 <code>Observable&lt;Response&lt;? extends BaseResponse&gt;</code>，实际上业务方想要的是 <code>Observable&lt;? extends BaseResponse&gt;</code>，那么我们就定义一个 <code>Transformer</code> 来转换这两个 <code>Observable</code>。</p>
<p><strong>转换过程其实就是一个错误处理的过程</strong>，因为我们要从 <code>Response</code> 中把 <code>BaseResponse</code> 剥离出来，如果 <code>Response</code> 或者 <code>BaseResponse</code> 中含有错误信息则意味着<strong>转换失败</strong>，直接抛出我们已经定义好的 <code>ErrorResponseException</code>，回调  <code>Subscriber</code> 的 <code>onError</code> 方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ErrorCheckerTransformer</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">Response</span>&lt;<span class="title">R</span>&gt;, <span class="title">R</span> <span class="keyword">extends</span> <span class="title">BaseResponse</span>&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">Observable</span>.<span class="title">Transformer</span>&lt;<span class="title">T</span>, <span class="title">R</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_ERROR_MESSAGE = <span class="string">"Oh, no"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> WeakReference&lt;Context&gt; contextRef;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ErrorCheckerTransformer</span><span class="params">(<span class="keyword">final</span> Context context)</span> </span>&#123;</span><br><span class="line">        contextRef = <span class="keyword">new</span> WeakReference&lt;&gt;(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Observable&lt;R&gt; <span class="title">call</span><span class="params">(Observable&lt;T&gt; observable)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> observable.map(<span class="keyword">new</span> Func1&lt;T, R&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> R <span class="title">call</span><span class="params">(T t)</span> </span>&#123;</span><br><span class="line">                String msg = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (!t.isSuccessful() || t.body() == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    msg = DEFAULT_ERROR_MESSAGE;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (t.body().errorResponse != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    msg = t.body().errorResponse.msg;</span><br><span class="line">                    <span class="keyword">if</span> (msg == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        msg = DEFAULT_ERROR_MESSAGE;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (t.body().code != BaseResponse.CODE_SUCCESS) &#123;</span><br><span class="line">                    msg = t.body().msg;</span><br><span class="line">                    <span class="keyword">if</span> (msg == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        msg = DEFAULT_ERROR_MESSAGE;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (msg != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> ErrorResponseException(msg);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (ErrorResponseException e) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> Exceptions.propagate(e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> t.body();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>除了获取错误信息 msg 之外，我们还可以根据 code 值来判断是否需要唤起登录：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">tryLogin</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> responseCode)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Context context = contextRef.get();</span><br><span class="line">    <span class="keyword">if</span> (context == <span class="keyword">null</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (responseCode == CODE_TOKEN_INVALID || responseCode == CODE_TOKEN_INVALID_PY</span><br><span class="line">            || responseCode == CODE_TOKEN_EMPTY) &#123;</span><br><span class="line">        LocalBroadcastManager.getInstance(context)</span><br><span class="line">                .sendBroadcast(<span class="keyword">new</span> Intent(INTENT_ACTION_LOGIN));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="创建-Service-Method"><a href="#创建-Service-Method" class="headerlink" title="创建 Service Method"></a>创建 Service Method</h2><p>不同的 Service Method 可能对应着不同的网关，因此我们需要定义一个工厂为不同的网关生产 Service Method。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceFactory</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String OLD_BASE_URL = <span class="string">"https://liangfeizc.com/gw/oauthentry/"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String NEW_BASE_URL = <span class="string">"https://liangfei.me/api/oauthentry/"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> OkHttpClient sClient = <span class="keyword">new</span> OkHttpClient.Builder()</span><br><span class="line">            .addInterceptor(<span class="keyword">new</span> Interceptor() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> Response <span class="title">intercept</span><span class="params">(Chain chain)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                    Request request = chain.request();</span><br><span class="line">                    HttpUrl url = request.url().newBuilder()</span><br><span class="line">                            .addQueryParameter(<span class="string">"access_token"</span>, UserInfo.getAccessToken())</span><br><span class="line">                            .build();</span><br><span class="line">                    request = request.newBuilder().url(url).build();</span><br><span class="line">                    <span class="keyword">return</span> chain.proceed(request);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">            .build();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">createOldService</span><span class="params">(Class&lt;T&gt; serviceClazz)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> createOauthService(OLD_BASE_URL, serviceClazz);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">createNewService</span><span class="params">(Class&lt;T&gt; serviceClazz)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> createOauthService(NEW_BASE_URL, serviceClazz);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">createOauthService</span><span class="params">(String baseUrl, Class&lt;T&gt; serviceClazz)</span> </span>&#123;</span><br><span class="line">        Retrofit retrofit = <span class="keyword">new</span> Retrofit.Builder()</span><br><span class="line">                .client(sClient)</span><br><span class="line">                .baseUrl(baseUrl)</span><br><span class="line">                .addConverterFactory(GsonConverterFactory.create())</span><br><span class="line">                .addCallAdapterFactory(RxJavaCallAdapterFactory.create())</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> retrofit.create(serviceClazz);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为这两个网关都要求登录后才能访问，因此我们通过 <code>OkHttpClient#addInterceptor</code> 拦截 <code>Request</code> 之后加上了参数 <code>access_token</code>。</p>
<h2 id="线程模型"><a href="#线程模型" class="headerlink" title="线程模型"></a>线程模型</h2><p>大多数情况下，我们都会在 io 线程发起 request，在主线程处理 response，所以我们定义了一个默认的线程模型：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SchedulerTransformer</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Observable</span>.<span class="title">Transformer</span>&lt;<span class="title">T</span>, <span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Observable&lt;T&gt; <span class="title">call</span><span class="params">(Observable&lt;T&gt; observable)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> observable</span><br><span class="line">                .subscribeOn(Schedulers.io())</span><br><span class="line">                .observeOn(AndroidSchedulers.mainThread());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">SchedulerTransformer&lt;T&gt; <span class="title">create</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SchedulerTransformer&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为了方便使用，我们又定义了一个 <code>SchedulerTransformer</code> 和 <code>ErrorCheckerTransformer</code> 的合体 <code>RemoteTransformer</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RemoteTransformer</span>&lt;<span class="title">R</span> <span class="keyword">extends</span> <span class="title">BaseResponse</span>&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">Observable</span>.<span class="title">Transformer</span>&lt;<span class="title">Response</span>&lt;<span class="title">R</span>&gt;, <span class="title">R</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Context mContext;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RemoteTransformer</span><span class="params">(<span class="keyword">final</span> Context context)</span> </span>&#123;</span><br><span class="line">        mContext = context;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Observable&lt;R&gt; <span class="title">call</span><span class="params">(Observable&lt;Response&lt;R&gt;&gt; observable)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> observable</span><br><span class="line">                .compose(<span class="keyword">new</span> SchedulerTransformer&lt;Response&lt;R&gt;&gt;())</span><br><span class="line">                .compose(<span class="keyword">new</span> ErrorCheckerTransformer&lt;Response&lt;R&gt;, R&gt;(mContext));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Subscriber"><a href="#Subscriber" class="headerlink" title="Subscriber"></a>Subscriber</h2><p>为了进一步统一错误消息的展示方式，我们又对 <code>Subscriber</code> 进行了一层封装。</p>
<h3 id="BaseSubscriber"><a href="#BaseSubscriber" class="headerlink" title="BaseSubscriber"></a>BaseSubscriber</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseSubscriber</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">Subscriber</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> WeakReference&lt;Context&gt; contextRef;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BaseSubscriber</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        contextRef = <span class="keyword">new</span> WeakReference&lt;&gt;(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Context <span class="title">getContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> contextRef == <span class="keyword">null</span> ? <span class="keyword">null</span> : contextRef.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Context context = contextRef.get();</span><br><span class="line">        <span class="keyword">if</span> (context == <span class="keyword">null</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (e != <span class="keyword">null</span> &amp;&amp; e <span class="keyword">instanceof</span> ErrorResponseException) &#123;</span><br><span class="line">            ErrorResponseException exception = (ErrorResponseException) e;</span><br><span class="line">            onError(exception);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 统一处理由 App 引发的错误</span></span><br><span class="line">            ErrorResponseException exception = <span class="keyword">new</span> ErrorResponseException(</span><br><span class="line">                    context.getString(R.string.zan_remote_request_failed),</span><br><span class="line">                    CODE_NETWORK_UNCONNECTED);</span><br><span class="line">            onError(exception);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(ErrorResponseException e)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ToastSubscriber"><a href="#ToastSubscriber" class="headerlink" title="ToastSubscriber"></a>ToastSubscriber</h3><p>以 Toast 形式展示错误消息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ToastSubscriber</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">BaseSubscriber</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ToastSubscriber</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Context context = getContext();</span><br><span class="line">        <span class="keyword">if</span> (context == <span class="keyword">null</span>) <span class="keyword">return</span>;</span><br><span class="line">        Toast.makeText(context, Errors.detailsOf(e), Toast.LENGTH_SHORT).show();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="DialogSubscriber"><a href="#DialogSubscriber" class="headerlink" title="DialogSubscriber"></a>DialogSubscriber</h3><p>以 Dialog 形式展示错误消息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">DialogSubscriber</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">BaseSubscriber</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DialogSubscriber</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@CallSuper</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line">        DialogUtil.showDialog(getContext(), e.getMessage(), <span class="string">"OK"</span>, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="统一-loading-动画"><a href="#统一-loading-动画" class="headerlink" title="统一 loading 动画"></a>统一 loading 动画</h2><p>每一次网络请求（Remote Request）都会触发一次 loading，而我们希望一个页面（Activity / Fragment）中重叠的多个请求只显示一次 loading 动画（可能是一个 ProgressBar）。<br>我们可以把请求队列看成一个栈，请求开始意味着入栈，请求完毕意味着出栈，为了简化代码，具体实现没必要使用 <code>Stack</code> 变量。 </p>
<p>因为基本上所有的请求都在页面中发起，所以我们在 BaseActivity 中展示 loading 动画：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseActivity</span> </span>&#123;</span><br><span class="line">    <span class="comment">// progress bar</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> progressCount;</span><br><span class="line">    <span class="keyword">private</span> View progressView;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showProgressBar</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (++progressCount == <span class="number">1</span>) &#123;</span><br><span class="line">            progressView = LayoutInflater.from(<span class="keyword">this</span>).inflate(R.layout.progressbar_layout, <span class="keyword">null</span>);</span><br><span class="line">            ViewGroup rootView = (ViewGroup) getWindow().getDecorView();</span><br><span class="line">            FrameLayout.LayoutParams params = <span class="keyword">new</span> FrameLayout.LayoutParams(</span><br><span class="line">                    FrameLayout.LayoutParams.WRAP_CONTENT, FrameLayout.LayoutParams.WRAP_CONTENT);</span><br><span class="line">            params.gravity = Gravity.CENTER;</span><br><span class="line">            rootView.addView(progressView, params);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hideProgressBar</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (progressCount &gt; <span class="number">0</span> &amp;&amp; --progressCount == <span class="number">0</span>) &#123;</span><br><span class="line">            ViewGroup rootView = (ViewGroup) getWindow().getDecorView();</span><br><span class="line">            rootView.removeView(progressView);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>为了方便 RxJava 使用，再定义一个方法来创建 <code>RemoteTransformer</code>：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Observable.compose(applyLoading()).</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &lt;T&gt; subclass of &#123;<span class="doctag">@link</span> BaseResponse&#125;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the composer of error checker and scheduler.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> &lt;T extends BaseResponse&gt; <span class="function">RemoteTransformer&lt;T&gt; <span class="title">applyLoading</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RemoteTransformer&lt;T&gt;(<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Observable&lt;T&gt; <span class="title">call</span><span class="params">(Observable&lt;Response&lt;T&gt;&gt; observable)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.call(observable).compose(BaseActivity.<span class="keyword">this</span>.&lt;T&gt;applyProgressBar());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; Observable.<span class="function">Transformer&lt;T, T&gt; <span class="title">applyProgressBar</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Observable.Transformer&lt;T, T&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Observable&lt;T&gt; <span class="title">call</span><span class="params">(Observable&lt;T&gt; observable)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> observable.doOnSubscribe(<span class="keyword">new</span> Action0() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    showProgressBar();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;).doOnCompleted(<span class="keyword">new</span> Action0() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    hideProgressBar();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;).doOnError(<span class="keyword">new</span> Action1&lt;Throwable&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Throwable throwable)</span> </span>&#123;</span><br><span class="line">                    hideProgressBar();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>除了网络请求，loading 可能会用于其他异步操作，因此单独定义了一个 <code>applyProgressBar</code> 方法。</p>
<p><code>BaseFragment</code> 直接调用 <code>BaseActivity</code> 的方法就可以了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseFragament</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">showProgressBar</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        BaseActivity activity = (BaseActivity) getActivity();</span><br><span class="line">        <span class="keyword">if</span> (activity != <span class="keyword">null</span>) &#123;</span><br><span class="line">            activity.showProgressBar();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">hideProgressBar</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        BaseActivity activity = (BaseActivity) getActivity();</span><br><span class="line">        <span class="keyword">if</span> (activity != <span class="keyword">null</span>) &#123;</span><br><span class="line">            activity.hideProgressBar();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> &lt;T&gt; Observable.<span class="function">Transformer&lt;T, T&gt; <span class="title">applyProgressBar</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ((BaseActivity) getActivity()).applyProgressBar();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;T extends BaseResponse&gt; <span class="function">RemoteTransformer&lt;T&gt; <span class="title">applyLoading</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ((BaseActivity) getActivity()).applyLoading();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="如何使用"><a href="#如何使用" class="headerlink" title="如何使用"></a>如何使用</h2><p>我们以获取 Category 为例来说明如何利用 Retrofit 和 RxAndroid 来改写现有模块。</p>
<h3 id="1-定义-CategoryResponse"><a href="#1-定义-CategoryResponse" class="headerlink" title="1. 定义 CategoryResponse"></a>1. 定义 CategoryResponse</h3><p><code>CategoryResponse</code> 必须继承自 <code>BaseResponse</code>，里面包含了错误信息的数据结构。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Keep</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CategoryResponse</span> <span class="keyword">extends</span> <span class="title">BaseResponse</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> Response response;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Keep</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Response</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> List&lt;Category&gt; categories;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中 <code>Category</code> 是具体的实体类型。</p>
<h3 id="2-定义-Service-Method"><a href="#2-定义-Service-Method" class="headerlink" title="2. 定义 Service Method"></a>2. 定义 Service Method</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TradeService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@GET</span>(<span class="string">"api.tradecategories/1.0.0/get"</span>)</span><br><span class="line">    Observable&lt;Response&lt;CategoryResponse&gt;&gt; tradeCategories();</span><br></pre></td></tr></table></figure>
<p><strong>注意点</strong></p>
<ul>
<li><code>TradeService</code> 必须是一个 <code>interface</code>，而且不能继承其他 <code>interface</code>。</li>
<li><code>tradeCategories</code> 的返回值必须是  <code>Observable&lt;Response&lt;? extends BaseResponse&gt;&gt;</code> 类型。</li>
</ul>
<h3 id="3-利用-ServiceFactory-创建一个-TradeService-实例"><a href="#3-利用-ServiceFactory-创建一个-TradeService-实例" class="headerlink" title="3. 利用 ServiceFactory 创建一个 TradeService 实例"></a>3. 利用 ServiceFactory 创建一个 TradeService 实例</h3><p>在适当的时机（<code>Activity#onCreate</code>、<code>Fragment#onViewCreated</code> 等）根据网关类型通过 <code>ServiceFactory</code> 创建一个 <code>TradeService</code> 实例。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mTradeService = ServiceFactory.createNewService(TradeService.class)</span><br></pre></td></tr></table></figure>
<h3 id="4-TradeService-获取数据"><a href="#4-TradeService-获取数据" class="headerlink" title="4. TradeService 获取数据"></a>4. TradeService 获取数据</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">mTradeService.tradeCategories()</span><br><span class="line">        .compose(<span class="keyword">new</span> RemoteTransformer&lt;CategoryResponse&gt;(getContext()))</span><br><span class="line">        .compose(applyLoading())</span><br><span class="line">        .map(<span class="keyword">new</span> Func1&lt;CategoryResponse, List&lt;Category&gt;&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> List&lt;Category&gt; <span class="title">call</span><span class="params">(CategoryResponse response)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> response.response.categories;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        .flatMap(<span class="keyword">new</span> Func1&lt;List&lt;Category&gt;, Observable&lt;Category&gt;&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Observable&lt;Category&gt; <span class="title">call</span><span class="params">(List&lt;Category&gt; categories)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> Observable.from(categories);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        .subscribe(<span class="keyword">new</span> ToastSubscriber&lt;Category&gt;(getActivity) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Category category)</span> </span>&#123;</span><br><span class="line">                <span class="comment">// business related code</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>
<p>注意：<code>RemoteTransformer</code> 包含了<strong>线程分配</strong>和<strong>错误处理</strong>两部分功能，所以调用方只需要关心正确的数据就可以了。</p>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><h3 id="NetworkBehavior-网络环境模拟"><a href="#NetworkBehavior-网络环境模拟" class="headerlink" title="NetworkBehavior - 网络环境模拟"></a>NetworkBehavior - 网络环境模拟</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">givenNetworkFailurePercentIs</span><span class="params">(<span class="keyword">int</span> failurePercent)</span> </span>&#123;</span><br><span class="line">    mNetworkBehavior.setDelay(<span class="number">0</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">    mNetworkBehavior.setVariancePercent(<span class="number">0</span>);</span><br><span class="line">    mNetworkBehavior.setFailurePercent(failurePercent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="TestSubscriber-带断言的-Subscriber"><a href="#TestSubscriber-带断言的-Subscriber" class="headerlink" title="TestSubscriber - 带断言的 Subscriber"></a>TestSubscriber - 带断言的 Subscriber</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> TestSubscriber&lt;Response&lt;CategoryResponse&gt;&gt; mTestSubscriberCategory = TestSubscriber.create()</span><br><span class="line">subscriber.assertError(RuntimeException.class);</span><br><span class="line">subscriber.assertNotCompleted();</span><br></pre></td></tr></table></figure>
<h3 id="MockRetrofit-为-Retrofit-添加-Mock-数据（NetworkBehavior-等）"><a href="#MockRetrofit-为-Retrofit-添加-Mock-数据（NetworkBehavior-等）" class="headerlink" title="MockRetrofit - 为 Retrofit 添加 Mock 数据（NetworkBehavior 等）"></a>MockRetrofit - 为 Retrofit 添加 Mock 数据（NetworkBehavior 等）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Before</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Retrofit retrofit = <span class="keyword">new</span> Retrofit.Builder()</span><br><span class="line">            .addConverterFactory(GsonConverterFactory.create())</span><br><span class="line">            .addCallAdapterFactory(RxJavaCallAdapterFactory.create())</span><br><span class="line">            .baseUrl(ServiceFactory.CARMEN_BASE_URL)</span><br><span class="line">            .build();</span><br><span class="line"></span><br><span class="line">    MockRetrofit mockRetrofit = <span class="keyword">new</span> MockRetrofit.Builder(retrofit)</span><br><span class="line">            .networkBehavior(mNetworkBehavior)</span><br><span class="line">            .build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="BehaviorDelegate-Retrofit-Service-的代理，用于产生-Mock-数据"><a href="#BehaviorDelegate-Retrofit-Service-的代理，用于产生-Mock-数据" class="headerlink" title="BehaviorDelegate - Retrofit Service 的代理，用于产生 Mock 数据"></a>BehaviorDelegate - Retrofit Service 的代理，用于产生 Mock 数据</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">BehaviorDelegate&lt;TradesService&gt; delegate = mockRetrofit.create(TradesService.class);</span><br><span class="line">mTradesServiceMock = <span class="keyword">new</span> TradesServiceMock(delegate);</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TradesServiceMock</span> <span class="keyword">implements</span> <span class="title">TradesService</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BehaviorDelegate&lt;TradesService&gt; mDelegate;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TradesServiceMock</span><span class="params">(BehaviorDelegate&lt;TradesService&gt; delegate)</span> </span>&#123;</span><br><span class="line">        mDelegate = delegate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Observable&lt;Response&lt;CategoryResponse&gt;&gt; tradeCategories() &#123;</span><br><span class="line">        <span class="keyword">return</span> mDelegate.returningResponse(<span class="string">"&#123;\"error_response\": \"my god\"&#125;"</span>).tradeCategories();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>通过以上实践可以看出，Retrofit + RxAndroid 大大改善了代码的可维护性。</p>
<ol>
<li>以 API 为中心，Request、Response、Method 一一对应，开发效率飙升</li>
<li>告别 Callback Hell，以同步方式写异步代码，让代码结构更清晰，更易于维护</li>
<li>基于事件，各种 Operator，四两拨千斤，尽情发挥你的想象力。</li>
</ol>


                <hr>

                <ul class="pager">
                    
                        <li class="previous">
                            <a href="/2016/07/10/android-diagram-retrofit-service-method/" data-toggle="tooltip" data-placement="top" title="图解 Retrofit 之 ServiceMethod">&larr; Previous Post</a>
                        </li>
                    
                    
                        <li class="next">
                            <a href="/2016/05/24/android-difference-between-application-id-and-package-name/" data-toggle="tooltip" data-placement="top" title="ApplicationId 与 PackageName 的区别">Next Post &rarr;</a>
                        </li>
                    
                </ul>

                
                <!-- disqus 评论框 start -->
                <div class="comment">
                    <div id="disqus_thread" class="disqus-thread"></div>
                </div>
                <!-- disqus 评论框 end -->
                

            </div>
    <!-- Side Catalog Container -->
        

    <!-- Sidebar Container -->

            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <!-- no hr -->
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                       
                          <a class="tag" href="/tags/#Android" title="Android">Android</a>
                        
                          <a class="tag" href="/tags/#Retrofit" title="Retrofit">Retrofit</a>
                        
                          <a class="tag" href="/tags/#RxJava" title="RxJava">RxJava</a>
                        
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
                <hr>
                <h5>FRIENDS</h5>
                <ul class="list-inline">

                    
                        <li><a href="http://yifeiyuan.me/" target="_blank">程序亦非猿</a></li>
                    
                        <li><a href="https://www.liaohuqiu.net/" target="_blank">秋百万</a></li>
                    
                        <li><a href="http://blog.zhaiyifan.cn/" target="_blank">大帅</a></li>
                    
                </ul>
                
            </div>

        </div>
    </div>
</article>


<script type="text/javascript">
/* * * CONFIGURATION VARIABLES * * */
var disqus_shortname = "http-www-liangfei-me";
var disqus_identifier = "http://liangfei.me/2016/07/06/android-retrofit-and-rxjava/";
var disqus_url = "http://liangfei.me/2016/07/06/android-retrofit-and-rxjava/";

var disqus_config = function () {
this.page.url = disqus_url;
this.page.identifier = disqus_identifier;
};

(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://' + disqus_shortname +'.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>




<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'always',
          placement: 'right',
          icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                
                    <li>
                        <a target="_blank" href="https://www.zhihu.com/people/liangfei.me">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa  fa-stack-1x fa-inverse">知</i>
                            </span>
                        </a>
                    </li>
                

                
                    <li>
                        <a target="_blank" href="http://weibo.com/liangfeizc">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                
                    <li>
                        <a target="_blank"  href="https://github.com/LyndonChin">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; LIANG.FEI 2018 
                    <br>
                    Theme by <a href="http://huangxuan.me">Hux</a> 
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js"></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- 
     Because of the native support for backtick-style fenced code blocks 
     right within the Markdown is landed in Github Pages, 
     From V1.6, There is no need for Highlight.js, 
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0  
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/    
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("http://liangfei.me/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Global site tag (gtag.js) - Google Analytics -->

    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-111924601-1"></script>
    <script>
        var _gaId = 'UA-111924601-1';

        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', _gaId);
    </script>


<!-- Baidu Tongji -->

<script>
    var _baId = '03812d0423cc43c7d86d65fd5bd22176';

    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?" + _baId;
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
</script>


<!-- Side Catalog -->




</body>

</html>
