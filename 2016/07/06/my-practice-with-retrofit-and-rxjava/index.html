<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Retrofit + RxAndroid 实践总结 | 梁飞</title>
  <meta name="author" content="liangfei">
  
  <meta name="description" content="梁飞的个人博客">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="Retrofit + RxAndroid 实践总结"/>
  <meta property="og:site_name" content="梁飞"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="梁飞" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  

</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">梁飞</a></h1>
  <h2><a href="/">行有不得反求诸己</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
      <li><a href="/about">About</a></li>
    
    <li><a href="https://github.com/lyndonchin">Github</a></li>
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2016-07-05T16:00:00.000Z"><a href="/2016/07/06/my-practice-with-retrofit-and-rxjava/">2016-07-06</a></time>
      
      
  
    <h1 class="title">Retrofit + RxAndroid 实践总结</h1>
  

    </header>
    <div class="entry">
      
        <p>在接入 Retrofit + RxAndroid 之前，项目代码中主要存在如下问题：</p>
<ol>
<li>服务器 API 的定义方式不一致，有的集中定义，有的定义在业务代码中，没有分类不便于维护。</li>
<li>Request / Response / API 三者没有对应关系（Request 参数使用 Map 传递，Response 返回 JSON 数据）。</li>
<li>每次都需要传递 <code>access_token</code> 给需要验证登录的 API。</li>
<li>Response 中错误信息的数据结构不一致，错误处理不统一。</li>
</ol>
<p>引入 Retrofit + RxAndroid 后，以上问题都会迎刃而解。</p>
<h2 id="定义基类"><a href="#定义基类" class="headerlink" title="定义基类"></a>定义基类</h2><p>首先定义一个 <code>BaseResponse</code>，所有的 Response 都要继承自它。</p>
<h3 id="Response"><a href="#Response" class="headerlink" title="Response"></a>Response</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Keep</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseResponse</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CODE_SUCCESS = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> String msg;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> code;</div><div class="line">    <span class="meta">@SerializedName</span>(<span class="string">"error_response"</span>)</div><div class="line">    <span class="keyword">public</span> ErrorResponse errorResponse;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ErrorResponse</span> </span>&#123;</div><div class="line">        <span class="keyword">public</span> String msg;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">int</span> code;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>BaseResponse</code> 的主要作用是统一了错误信息的格式，同时为后面统一错误处理打好基础。</p>
<h3 id="ErrorResponseException"><a href="#ErrorResponseException" class="headerlink" title="ErrorResponseException"></a>ErrorResponseException</h3><p>为了统一<strong>请求错误</strong>和<strong>返回错误</strong>，我们定义了一个继承自 <code>IOException</code> 的子类 <code>ErrorResponseException</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ErrorResponseException</span> <span class="keyword">extends</span> <span class="title">IOException</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ErrorResponseException</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ErrorResponseException</span><span class="params">(String detailMessage)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(detailMessage);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="定义-Service-Method"><a href="#定义-Service-Method" class="headerlink" title="定义 Service Method"></a>定义 Service Method</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TradesService</span> </span>&#123;</div><div class="line">    <span class="meta">@GET</span>(<span class="string">"api.tradecategories/1.0.0/get"</span>)</div><div class="line">    Observable&lt;Response&lt;CategoryResponse&gt;&gt; tradeCategories();</div><div class="line"></div><div class="line">    <span class="meta">@FormUrlEncoded</span></div><div class="line">    <span class="meta">@GET</span>(<span class="string">"api.trade/1.0.0/get"</span>)</div><div class="line">    Observable&lt;Response&lt;TradeItemResponse&gt;&gt; tradeDetail(<span class="meta">@Field</span>(<span class="string">"tid"</span>) String tid);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其中 <code>CategoryResponse</code>、<code>TradeItemResponse</code> 全部继承自 <code>BaseResponse</code>。</p>
<p>泛型 <code>Response</code> 由 Retrofit 提供，定义了三个成员变量：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> okhttp3.Response rawResponse;</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> T body;</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> ResponseBody errorBody;</div></pre></td></tr></table></figure>
<p>可以看出，<code>Response</code> 是对 <code>okhttp3.Response</code> 的封装，<code>body</code> 是一个 <code>BaseResponse</code> 实例。</p>
<p>因为 <code>Response</code> 只会根据 <code>code</code> 值判断请求是否成功，而不会判断 <code>body</code> 的内容是否出错，所以我们把 <code>Response</code> 中的错误信息称作<strong>请求错误</strong>，把 <code>body</code> 中的错误信息称作<strong>返回错误</strong>。</p>
<p>既然 <code>Response</code> 包含了 <code>BaseResponse</code>（即 <code>body</code>），那么我们就可以对两种错误（请求错误、返回错误）进行统一处理。</p>
<h2 id="统一错误处理"><a href="#统一错误处理" class="headerlink" title="统一错误处理"></a>统一错误处理</h2><p>Service Method 的返回值类型是 <code>Observable&lt;Response&lt;? extends BaseResponse&gt;</code>，实际上业务方想要的是 <code>Observable&lt;? extends BaseResponse&gt;</code>，那么我们就定义一个 <code>Transformer</code> 来转换这两个 <code>Observable</code>。</p>
<p><strong>转换过程其实就是一个错误处理的过程</strong>，因为我们要从 <code>Response</code> 中把 <code>BaseResponse</code> 剥离出来，如果 <code>Response</code> 或者 <code>BaseResponse</code> 中含有错误信息则意味着<strong>转换失败</strong>，直接抛出我们已经定义好的 <code>BaseErrorResponse</code>，回调  <code>Subscriber</code> 的 <code>onError</code> 方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ErrorCheckerTransformer</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">Response</span>&lt;<span class="title">R</span>&gt;, <span class="title">R</span> <span class="keyword">extends</span> <span class="title">BaseResponse</span>&gt;</span></div><div class="line">        <span class="keyword">implements</span> <span class="title">Observable</span>.<span class="title">Transformer</span>&lt;<span class="title">T</span>, <span class="title">R</span>&gt; &#123;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_ERROR_MESSAGE = <span class="string">"Oh, no"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Context mContext;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ErrorCheckerTransformer</span><span class="params">(<span class="keyword">final</span> Context context)</span> </span>&#123;</div><div class="line">        mContext = context;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Observable&lt;R&gt; <span class="title">call</span><span class="params">(Observable&lt;T&gt; observable)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> observable.map(<span class="keyword">new</span> Func1&lt;T, R&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> R <span class="title">call</span><span class="params">(T t)</span> </span>&#123;</div><div class="line">                String msg = <span class="keyword">null</span>;</div><div class="line">                <span class="keyword">if</span> (!t.isSuccessful() || t.body() == <span class="keyword">null</span>) &#123;</div><div class="line">                    msg = DEFAULT_ERROR_MESSAGE;</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (t.body().errorResponse != <span class="keyword">null</span>) &#123;</div><div class="line">                    msg = t.body().errorResponse.msg;</div><div class="line">                    <span class="keyword">if</span> (msg == <span class="keyword">null</span>) &#123;</div><div class="line">                        msg = DEFAULT_ERROR_MESSAGE;</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (t.body().code != BaseResponse.CODE_SUCCESS) &#123;</div><div class="line">                    msg = t.body().msg;</div><div class="line">                    <span class="keyword">if</span> (msg == <span class="keyword">null</span>) &#123;</div><div class="line">                        msg = DEFAULT_ERROR_MESSAGE;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (msg != <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> ErrorResponseException(msg);</div><div class="line">                    &#125; <span class="keyword">catch</span> (ErrorResponseException e) &#123;</div><div class="line">                        <span class="keyword">throw</span> Exceptions.propagate(e);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">return</span> t.body();</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当然，你也可以在这里判断是否需要唤起登录请求。</p>
<h2 id="创建-Service-Method"><a href="#创建-Service-Method" class="headerlink" title="创建 Service Method"></a>创建 Service Method</h2><p>不同的 Service Method 可能对应着不同的网关，因此我们需要定义一个工厂为不同的网关生产 Service Method。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceFactory</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String OLD_BASE_URL = <span class="string">"https://liangfeizc.com/gw/oauthentry/"</span>;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String NEW_BASE_URL = <span class="string">"https://liangfei.me/api/oauthentry/"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> OkHttpClient sClient = <span class="keyword">new</span> OkHttpClient.Builder()</div><div class="line">            .addInterceptor(<span class="keyword">new</span> Interceptor() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> Response <span class="title">intercept</span><span class="params">(Chain chain)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">                    Request request = chain.request();</div><div class="line">                    HttpUrl url = request.url().newBuilder()</div><div class="line">                            .addQueryParameter(<span class="string">"access_token"</span>, UserInfo.getAccessToken())</div><div class="line">                            .build();</div><div class="line">                    request = request.newBuilder().url(url).build();</div><div class="line">                    <span class="keyword">return</span> chain.proceed(request);</div><div class="line">                &#125;</div><div class="line">            &#125;)</div><div class="line">            .build();</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">createOldService</span><span class="params">(Class&lt;T&gt; serviceClazz)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> createOauthService(OLD_BASE_URL, serviceClazz);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">createNewService</span><span class="params">(Class&lt;T&gt; serviceClazz)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> createOauthService(NEW_BASE_URL, serviceClazz);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">createOauthService</span><span class="params">(String baseUrl, Class&lt;T&gt; serviceClazz)</span> </span>&#123;</div><div class="line">        Retrofit retrofit = <span class="keyword">new</span> Retrofit.Builder()</div><div class="line">                .client(sClient)</div><div class="line">                .baseUrl(baseUrl)</div><div class="line">                .addConverterFactory(GsonConverterFactory.create())</div><div class="line">                .addCallAdapterFactory(RxJavaCallAdapterFactory.create())</div><div class="line">                .build();</div><div class="line"></div><div class="line">        <span class="keyword">return</span> retrofit.create(serviceClazz);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>因为这两个网关都要求登录后才能访问，因此我们通过 <code>OkHttpClient#addInterceptor</code> 拦截 <code>Request</code> 之后加上了参数 <code>access_token</code>。</p>
<h2 id="线程模型"><a href="#线程模型" class="headerlink" title="线程模型"></a>线程模型</h2><p>大多数情况下，我们都会在 io 线程发起 request，在主线程处理 response，所以我们定义了一个默认的线程模型：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SchedulerTransformer</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Observable</span>.<span class="title">Transformer</span>&lt;<span class="title">T</span>, <span class="title">T</span>&gt; </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Observable&lt;T&gt; <span class="title">call</span><span class="params">(Observable&lt;T&gt; observable)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> observable</div><div class="line">                .subscribeOn(Schedulers.io())</div><div class="line">                .observeOn(AndroidSchedulers.mainThread());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">SchedulerTransformer&lt;T&gt; <span class="title">create</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SchedulerTransformer&lt;&gt;();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>为了方便使用，我们又定义了一个 <code>DefaultTransformer</code> 把 <code>SchedulerTransformer</code> 和 <code>ErrorCheckerTransformer</code> 结合起来。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultTransformer</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">Response</span>&lt;<span class="title">R</span>&gt;, <span class="title">R</span> <span class="keyword">extends</span> <span class="title">BaseResponse</span>&gt;</span></div><div class="line">        <span class="keyword">implements</span> <span class="title">Observable</span>.<span class="title">Transformer</span>&lt;<span class="title">T</span>, <span class="title">R</span>&gt; &#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Context mContext;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DefaultTransformer</span><span class="params">(<span class="keyword">final</span> Context context)</span> </span>&#123;</div><div class="line">        mContext = context;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Observable&lt;R&gt; <span class="title">call</span><span class="params">(Observable&lt;T&gt; observable)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> observable</div><div class="line">                .compose(<span class="keyword">new</span> SchedulerTransformer&lt;T&gt;())</div><div class="line">                .compose(<span class="keyword">new</span> ErrorCheckerTransformer&lt;T, R&gt;(mContext));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Subscriber"><a href="#Subscriber" class="headerlink" title="Subscriber"></a>Subscriber</h2><p>为了进一步统一错误消息的展示方式，我们又对 <code>Subscriber</code> 进行了一层封装。</p>
<h3 id="BaseSubscriber"><a href="#BaseSubscriber" class="headerlink" title="BaseSubscriber"></a>BaseSubscriber</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseSubscriber</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">Subscriber</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">    <span class="keyword">private</span> Context mContext;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BaseSubscriber</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        mContext = context;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Context <span class="title">getContext</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> mContext;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="ToastSubscriber"><a href="#ToastSubscriber" class="headerlink" title="ToastSubscriber"></a>ToastSubscriber</h3><p>以 Toast 形式展示错误消息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ToastSubscriber</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">BaseSubscriber</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ToastSubscriber</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@CallSuper</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line">        ToastUtil.show(getContext(), e.getMessage());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="DialogSubscriber"><a href="#DialogSubscriber" class="headerlink" title="DialogSubscriber"></a>DialogSubscriber</h3><p>以 Dialog 形式展示错误消息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">DialogSubscriber</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">BaseSubscriber</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DialogSubscriber</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@CallSuper</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line">        DialogUtil.showDialog(getContext(), e.getMessage(), <span class="string">"OK"</span>, <span class="keyword">true</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="如何使用"><a href="#如何使用" class="headerlink" title="如何使用"></a>如何使用</h2><p>我们以获取 Category 为例来说明如何利用 Retrofit 和 RxAndroid 来改写现有模块。</p>
<h3 id="1-定义-CategoryResponse"><a href="#1-定义-CategoryResponse" class="headerlink" title="1. 定义 CategoryResponse"></a>1. 定义 CategoryResponse</h3><p><code>CategoryResponse</code> 必须继承自 <code>BaseResponse</code>，里面包含了错误信息的数据结构。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Keep</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CategoryResponse</span> <span class="keyword">extends</span> <span class="title">BaseResponse</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> Response response;</div><div class="line"></div><div class="line">    <span class="meta">@Keep</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Response</span> </span>&#123;</div><div class="line">        <span class="keyword">public</span> List&lt;Category&gt; categories;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其中 <code>Category</code> 是具体的实体类型。</p>
<h3 id="2-定义-Service-Method"><a href="#2-定义-Service-Method" class="headerlink" title="2. 定义 Service Method"></a>2. 定义 Service Method</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TradesService</span> </span>&#123;</div><div class="line">    <span class="meta">@GET</span>(<span class="string">"api.tradecategories/1.0.0/get"</span>)</div><div class="line">    Observable&lt;Response&lt;CategoryResponse&gt;&gt; tradeCategories();</div></pre></td></tr></table></figure>
<p><strong>注意点</strong></p>
<ul>
<li><code>TradesService</code> 必须是一个 <code>interface</code>，而且不能继承其他 <code>interface</code>。</li>
<li><code>tradeCategories</code> 的返回值必须是  <code>Observable&lt;Response&lt;? extends BaseResponse&gt;&gt;</code> 类型。</li>
</ul>
<h3 id="3-利用-ServiceFactory-创建一个-TradeService-实例"><a href="#3-利用-ServiceFactory-创建一个-TradeService-实例" class="headerlink" title="3. 利用 ServiceFactory 创建一个  TradeService 实例"></a>3. 利用 ServiceFactory 创建一个  TradeService 实例</h3><p>在适当的时机（<code>Activity#onCreate</code>、<code>Fragment#onViewCreated</code> 等）根据网关类型通过 <code>ServiceFactory</code> 创建一个 <code>TradeService</code> 实例。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mTradesService = ServiceFactory.createNewService(TradesService.class)</div></pre></td></tr></table></figure>
<h3 id="4-TradeService-获取数据"><a href="#4-TradeService-获取数据" class="headerlink" title="4. TradeService 获取数据"></a>4. TradeService 获取数据</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">mTradesService.tradeCategories()</div><div class="line">        .compose(<span class="keyword">new</span> DefaultTransformer&lt;Response&lt;CategoryResponse&gt;, CategoryResponse&gt;(getActivity()))</div><div class="line">        .map(<span class="keyword">new</span> Func1&lt;CategoryResponse, List&lt;Category&gt;&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> List&lt;Category&gt; <span class="title">call</span><span class="params">(CategoryResponse response)</span> </span>&#123;</div><div class="line">                <span class="keyword">return</span> response.response.categories;</div><div class="line">            &#125;</div><div class="line">        &#125;)</div><div class="line">        .flatMap(<span class="keyword">new</span> Func1&lt;List&lt;Category&gt;, Observable&lt;Category&gt;&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> Observable&lt;Category&gt; <span class="title">call</span><span class="params">(List&lt;Category&gt; categories)</span> </span>&#123;</div><div class="line">                <span class="keyword">return</span> Observable.from(categories);</div><div class="line">            &#125;</div><div class="line">        &#125;)</div><div class="line">        .subscribe(<span class="keyword">new</span> ToastSubscriber&lt;Category&gt;(getActivity) &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</div><div class="line">                hideProgressBar();</div><div class="line">                <span class="comment">// business related code</span></div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line">                <span class="keyword">super</span>.onError(e);</div><div class="line">                hideProgressBar();</div><div class="line">                <span class="comment">// business related code</span></div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Category category)</span> </span>&#123;</div><div class="line">                <span class="comment">// business related code</span></div><div class="line">            &#125;</div><div class="line">        &#125;);</div></pre></td></tr></table></figure>
<p>注意：<code>DefaultTransformer</code> 包含了<strong>线程分配</strong>和<strong>错误处理</strong>两部分功能，所以调用方只需要关心正确的数据就可以了。</p>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><h3 id="NetworkBehavior-网络环境模拟"><a href="#NetworkBehavior-网络环境模拟" class="headerlink" title="NetworkBehavior - 网络环境模拟"></a>NetworkBehavior - 网络环境模拟</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">givenNetworkFailurePercentIs</span><span class="params">(<span class="keyword">int</span> failurePercent)</span> </span>&#123;</div><div class="line">    mNetworkBehavior.setDelay(<span class="number">0</span>, TimeUnit.MILLISECONDS);</div><div class="line">    mNetworkBehavior.setVariancePercent(<span class="number">0</span>);</div><div class="line">    mNetworkBehavior.setFailurePercent(failurePercent);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="TestSubscriber-带断言的-Subscriber"><a href="#TestSubscriber-带断言的-Subscriber" class="headerlink" title="TestSubscriber - 带断言的 Subscriber"></a>TestSubscriber - 带断言的 Subscriber</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> TestSubscriber&lt;Response&lt;CategoryResponse&gt;&gt; mTestSubscriberCategory = TestSubscriber.create()</div><div class="line">subscriber.assertError(RuntimeException.class);</div><div class="line">subscriber.assertNotCompleted();</div></pre></td></tr></table></figure>
<h3 id="MockRetrofit-为-Retrofit-添加-Mock-数据（NetworkBehavior-等）"><a href="#MockRetrofit-为-Retrofit-添加-Mock-数据（NetworkBehavior-等）" class="headerlink" title="MockRetrofit - 为 Retrofit 添加 Mock 数据（NetworkBehavior 等）"></a>MockRetrofit - 为 Retrofit 添加 Mock 数据（NetworkBehavior 等）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Before</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> </span>&#123;</div><div class="line">    Retrofit retrofit = <span class="keyword">new</span> Retrofit.Builder()</div><div class="line">            .addConverterFactory(GsonConverterFactory.create())</div><div class="line">            .addCallAdapterFactory(RxJavaCallAdapterFactory.create())</div><div class="line">            .baseUrl(ServiceFactory.CARMEN_BASE_URL)</div><div class="line">            .build();</div><div class="line"></div><div class="line">    MockRetrofit mockRetrofit = <span class="keyword">new</span> MockRetrofit.Builder(retrofit)</div><div class="line">            .networkBehavior(mNetworkBehavior)</div><div class="line">            .build();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="BehaviorDelegate-Retrofit-Service-的代理，用于产生-Mock-数据"><a href="#BehaviorDelegate-Retrofit-Service-的代理，用于产生-Mock-数据" class="headerlink" title="BehaviorDelegate - Retrofit Service 的代理，用于产生 Mock 数据"></a>BehaviorDelegate - Retrofit Service 的代理，用于产生 Mock 数据</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">BehaviorDelegate&lt;TradesService&gt; delegate = mockRetrofit.create(TradesService.class);</div><div class="line">mTradesServiceMock = <span class="keyword">new</span> TradesServiceMock(delegate);</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TradesServiceMock</span> <span class="keyword">implements</span> <span class="title">TradesService</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BehaviorDelegate&lt;TradesService&gt; mDelegate;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TradesServiceMock</span><span class="params">(BehaviorDelegate&lt;TradesService&gt; delegate)</span> </span>&#123;</div><div class="line">        mDelegate = delegate;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> Observable&lt;Response&lt;CategoryResponse&gt;&gt; tradeCategories() &#123;</div><div class="line">        <span class="keyword">return</span> mDelegate.returningResponse(<span class="string">"&#123;\"error_response\": \"my god\"&#125;"</span>).tradeCategories();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>通过以上实践可以看出，Retrofit + RxAndroid 大大改善了代码的可维护性。</p>
<ol>
<li>以 API 为中心，Request、Response、Method 一一对应，开发效率飙升</li>
<li>告别 Callback Hell，以同步方式写异步代码，让代码结构更清晰，更易于维护</li>
<li>基于事件，各种 Operator，四两拨千斤，尽情发挥你的想象力。</li>
</ol>
<h2 id="修订"><a href="#修订" class="headerlink" title="修订"></a>修订</h2><p>谢谢 <a href="http://www.jianshu.com/users/ec59bd61433a" target="_blank" rel="external">程序亦非猿</a> 指出，<code>OkHttpClient</code> 修改为单例。</p>
<blockquote>
<p>Most applications should call new OkHttpClient()<br> exactly once, configure it with their cache, and use that same instance everywhere. Otherwise the two cache instances will stomp on each other, corrupt the response cache, and possibly crash your program.</p>
</blockquote>

      
    </div>
    <footer>
      
        
        
  
  <div class="tags">
    <a href="/tags/Retrofit/">Retrofit</a>, <a href="/tags/RxJava/">RxJava</a>
  </div>

        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


<section id="comment">
  <h1 class="title">留言</h1>
  <div id="uyan_frame"></div>
  <script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=2128686"></script>
</section>


</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="搜索">
    <input type="hidden" name="q" value="site:liangfei.me">
  </form>
</div>

  

  
<div class="widget tagcloud">
  <h3 class="title">标签云</h3>
  <div class="entry">
    <a href="/tags/Android/" style="font-size: 20px;">Android</a> <a href="/tags/Git/" style="font-size: 12.5px;">Git</a> <a href="/tags/Gradle/" style="font-size: 10px;">Gradle</a> <a href="/tags/Hybrid/" style="font-size: 10px;">Hybrid</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/Retrofit/" style="font-size: 12.5px;">Retrofit</a> <a href="/tags/RxJava/" style="font-size: 10px;">RxJava</a> <a href="/tags/Web/" style="font-size: 12.5px;">Web</a> <a href="/tags/dart/" style="font-size: 10px;">dart</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/iOS/" style="font-size: 10px;">iOS</a> <a href="/tags/个人总结/" style="font-size: 17.5px;">个人总结</a> <a href="/tags/产品设计/" style="font-size: 10px;">产品设计</a> <a href="/tags/单元测试/" style="font-size: 10px;">单元测试</a> <a href="/tags/汽车/" style="font-size: 10px;">汽车</a> <a href="/tags/移动开发/" style="font-size: 10px;">移动开发</a>
  </div>
</div>


  
<div class="widget tag">
  <h3 class="title">最新文章</h3>
  <ul class="entry">
    
      <li>
        <a href="/2017/07/04/2017-semi-annual-summary/">2017 年中总结</a>
      </li>
    
      <li>
        <a href="/2017/03/21/app-force-update-architecture/">Android 强升逻辑和实现</a>
      </li>
    
      <li>
        <a href="/2017/02/15/2016-summary/">2016 年终总结</a>
      </li>
    
      <li>
        <a href="/2017/02/04/thinking-in-mobile/">关于 App 开发的一些思考</a>
      </li>
    
      <li>
        <a href="/2017/02/01/note-on-web-data-analysis/">架构笔记之数据分析</a>
      </li>
    
  </ul>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2017 liangfei
  
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>


<script type="text/javascript">
var disqus_shortname = 'liangfeizc';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>